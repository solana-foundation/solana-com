---
title: 支出权限
description: 将 token 支出权限委托给第三方，实现自动化和托管支付
---

Solana 的 Token
Programs 支持**委托**功能——允许你授权其他账户在指定额度内，从你的 token
account 转移 token。这使得自动化支付、托管服务和第三方支付处理等场景成为可能，同时无需放弃对资金的控制权。

## 委托的工作原理

当你批准一个代理人（delegate）时，就是授权某个特定账户可以代表你转移 token：

- **所有权不变**：你仍然拥有这些 token，并可随时转移或撤销权限
- **支出额度受限**：代理人只能在批准的额度内转移 token
- **每个账户仅限一个代理**：每个 token account 只能有一个活跃代理
- **新授权覆盖旧授权**：批准新代理会自动撤销之前的代理权限

<Callout type="info">
  委托是非托管的。代理人只能在额度范围内支出
  token，无法访问或转移超出批准额度的资金。账户所有者可随时撤销权限。
</Callout>

## 商业应用场景

| 应用场景           | 委托如何发挥作用                           |
| ------------------ | ------------------------------------------ |
| **支付处理商**     | 商户授权处理商结算交易                     |
| **自动化工资发放** | 财务部门批准工资服务商发放薪资             |
| **托管服务**       | 买方将权限委托给托管代理人以实现有条件释放 |
| **交易平台**       | 用户授权交易所代表其执行交易               |
| **卡片发行**       | 用户授权发卡机构将消费记入其 token account |

## 授权代理人

授权其他账户从你的账户中支出代币：

<CodeTabs storage="kit-cli">

```ts !! title="Kit"
import { getApproveCheckedInstruction } from "@solana-program/token";

// Approve delegate to spend up to 1,000 USDC (6 decimals)
const approveInstruction = getApproveCheckedInstruction({
  source: tokenAccountAddress, // Your token account
  mint: usdcMintAddress, // USDC mint
  delegate: delegateAddress, // Account receiving permission
  owner: ownerKeypair, // You (must sign)
  amount: 1_000_000_000n, // 1,000 USDC in base units
  decimals: 6
});
```

```bash !! title="CLI"
spl-token approve <TOKEN_ACCOUNT> <AMOUNT> <DELEGATE_ADDRESS>
# Example: Approve 1000 USDC to a delegate
spl-token approve 7v45Foih... 1000 DeLe9ate...
```

</CodeTabs>

**参数：**

- `source`：授予权限的 token account
- `delegate`：将获得支出权限的账户
- `owner`：token account 当前所有者（必须签署交易）
- `amount`：代理可转移的最大代币数量
- `decimals`：用于校验的代币小数位数（防止小数错误）

### 演示

<CodeTabs flags="r">

```ts !! title="Approve Delegate"
// !collapse(1:15) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  findAssociatedTokenPda,
  getMintToInstruction,
  getApproveCheckedInstruction,
  fetchToken,
  TOKEN_2022_PROGRAM_ADDRESS
} from "@solana-program/token-2022";

// Generate keypairs for sender and delegate
const sender = (await generateKeypair()).signer;
const delegate = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Delegate Address:", delegate.address);

// Demo Setup: Create client, mint account, token account, and fund with initial tokens
const { client, mint, senderAta } = await demoSetup(sender);

console.log("\nMint Address:", mint.address);
console.log("Sender ATA:", senderAta);

// =============================================================================
// Approve Delegate
// =============================================================================

// Create instruction to approve delegate
// !mark(1:8)
const approveInstruction = getApproveCheckedInstruction({
  source: senderAta,
  mint: mint.address,
  delegate: delegate.address,
  owner: sender,
  amount: 1_000_000n, // 1.0 tokens with 6 decimals
  decimals: 6
});

// Send approve transaction
// !mark(1:4)
const signature = await client.transaction.prepareAndSend({
  authority: sender,
  instructions: [approveInstruction]
});

console.log("\n=== Approve Delegate ===");
console.log("Transaction Signature:", signature);

// Fetch token account data to show delegate is set
const tokenData = await fetchToken(client.runtime.rpc, senderAta);
console.log("\nSender Token Account Data:", tokenData.data);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a delegate demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sender for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token account for sender
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @returns Returns client instance, mint, and ATA address
 */
async function demoSetup(sender: ServerKeypair["signer"]) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sender with SOL for transaction fees
  await client.actions.requestAirdrop(sender.address, lamports(1_000_000_000n));

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sender,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sender,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction to mint initial tokens to sender
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender.address,
    amount: 2_000_000n // Mint 2.00 tokens (2,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client
  await client.transaction.prepareAndSend({
    authority: sender,
    instructions: setupInstructions
  });

  return {
    client,
    mint,
    senderAta
  };
}
```

</CodeTabs>

## 撤销代理

移除当前代理的所有支出权限：

<CodeTabs storage="kit-cli">

```ts !! title="Kit"
import { getRevokeInstruction } from "@solana-program/token";

const revokeInstruction = getRevokeInstruction({
  source: tokenAccountAddress, // Your token account
  owner: ownerKeypair // You (must sign)
});
```

```bash !! title="CLI"
spl-token revoke <TOKEN_ACCOUNT>
```

</CodeTabs>

<Callout type="caution">
  撤销会移除**所有**代理权限——无法部分撤销。如果你需要降低额度，请用更低的金额重新授权同一个代理。
</Callout>

### 演示

<CodeTabs flags="r">

```ts !! title="Revoke Delegate"
// !collapse(1:16) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  findAssociatedTokenPda,
  getMintToInstruction,
  getApproveCheckedInstruction,
  getRevokeInstruction,
  fetchToken,
  TOKEN_2022_PROGRAM_ADDRESS
} from "@solana-program/token-2022";

// Generate keypairs for sender and delegate
const sender = (await generateKeypair()).signer;
const delegate = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Delegate Address:", delegate.address);

// Demo Setup: Create client, mint account, token account, and fund with initial tokens
const { client, mint, senderAta } = await demoSetup(sender);

console.log("\nMint Address:", mint.address);
console.log("Sender ATA:", senderAta);

// =============================================================================
// Transaction 1: Approve Delegate
// =============================================================================

// Create instruction to approve delegate
// !mark(1:8)
const approveInstruction = getApproveCheckedInstruction({
  source: senderAta,
  mint: mint.address,
  delegate: delegate.address,
  owner: sender,
  amount: 1_000_000n, // 1.0 tokens with 6 decimals
  decimals: 6
});

// Send approve transaction
// !mark(1:5)
const approveSignature = await client.transaction.prepareAndSend({
  authority: sender,
  instructions: [approveInstruction]
});

console.log("\n=== Transaction 1: Approve Delegate ===");
console.log("Transaction Signature:", approveSignature);

// Fetch token account data to show delegate is set
const tokenDataAfterApprove = await fetchToken(client.runtime.rpc, senderAta);
console.log("\nSender Token Account Data:", tokenDataAfterApprove.data);

// =============================================================================
// Transaction 2: Revoke Delegate
// =============================================================================

// Create instruction to revoke delegate
// !mark(1:4)
const revokeInstruction = getRevokeInstruction({
  source: senderAta,
  owner: sender
});

// Send revoke transaction
// !mark(1:5)
const revokeSignature = await client.transaction.prepareAndSend({
  authority: sender,
  instructions: [revokeInstruction]
});

console.log("\n=== Transaction 2: Revoke Delegate ===");
console.log("Transaction Signature:", revokeSignature);

// Fetch token account data to show delegate is revoked
const tokenDataAfterRevoke = await fetchToken(client.runtime.rpc, senderAta);
console.log("\nSender Token Account Data:", tokenDataAfterRevoke.data);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a delegate demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sender for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token account for sender
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @returns Returns client instance, mint, and ATA address
 */
async function demoSetup(sender: ServerKeypair["signer"]) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sender with SOL for transaction fees
  await client.actions.requestAirdrop(sender.address, lamports(1_000_000_000n));

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sender,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sender,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction to mint initial tokens to sender
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender.address,
    amount: 2_000_000n // Mint 2.00 tokens (2,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client
  await client.transaction.prepareAndSend({
    authority: sender,
    instructions: setupInstructions
  });

  return {
    client,
    mint,
    senderAta
  };
}
```

</CodeTabs>

## 作为代理进行转账

作为代理操作时，使用标准转账，但需用代理的 keypair 签名，而不是所有者：

```ts title="Transfer as Delegate"
import { getTransferCheckedInstruction } from "@solana-program/token";

const transferInstruction = getTransferCheckedInstruction({
  source: ownerTokenAccount, // The account you have permission to spend from
  mint: usdcMintAddress,
  destination: recipientTokenAccount,
  authority: delegateKeypair, // You (the delegate) sign, not the owner
  amount: 100_000_000n, // 100 USDC
  decimals: 6
});
```

转账成功的条件：

- 源账户余额充足
- 代理签署了交易

每次转账都会减少剩余额度。当额度为零时，代理将无法再转移代币。

### 演示

<CodeTabs flags="r">

```ts !! title="Transfer as Delegate"
// !collapse(1:16) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  findAssociatedTokenPda,
  getMintToInstruction,
  getApproveCheckedInstruction,
  getTransferCheckedInstruction,
  fetchToken,
  TOKEN_2022_PROGRAM_ADDRESS
} from "@solana-program/token-2022";

// Generate keypairs for sender, delegate, and recipient
const sender = (await generateKeypair()).signer;
const delegate = (await generateKeypair()).signer;
const recipient = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Delegate Address:", delegate.address);
console.log("Recipient Address:", recipient.address);

// Demo Setup: Create client, mint account, token accounts, and fund with initial tokens
const { client, mint, senderAta, recipientAta } = await demoSetup(
  sender,
  delegate,
  recipient
);

console.log("\nMint Address:", mint.address);
console.log("Sender ATA:", senderAta);
console.log("Recipient ATA:", recipientAta);

// =============================================================================
// Transaction 1: Approve Delegate
// =============================================================================

// Create instruction to approve delegate
// !mark(1:8)
const approveInstruction = getApproveCheckedInstruction({
  source: senderAta,
  mint: mint.address,
  delegate: delegate.address,
  owner: sender,
  amount: 1_000_000n, // 1.0 tokens with 6 decimals
  decimals: 6
});

// Send approve transaction
const approveSignature = await client.transaction.prepareAndSend({
  authority: sender,
  instructions: [approveInstruction]
});

console.log("\n=== Transaction 1: Approve Delegate ===");
console.log("Delegate Address:", delegate.address);
console.log("Transaction Signature:", approveSignature);

// =============================================================================
// Fetch Token Account Data to Demonstrate Delegate is Set
// =============================================================================

const tokenAccountData = await fetchToken(client.runtime.rpc, senderAta);
console.log("\nSender Token Account Data:", tokenAccountData.data);

// =============================================================================
// Transaction 2: Transfer Using Delegate
// =============================================================================

// Create instruction to transfer tokens using delegate
// Note: delegate is the authority here, not the owner
const transferInstruction = getTransferCheckedInstruction({
  source: senderAta,
  mint: mint.address,
  destination: recipientAta,
  // !mark
  authority: delegate, // Delegate signs this transaction
  amount: 500_000n, // 0.5 tokens with 6 decimals
  decimals: 6
});

// Send transfer transaction
// Delegate pays for the transaction and authorizes the transfer (sender not needed)
const transferSignature = await client.transaction.prepareAndSend({
  // !mark
  authority: delegate, // Delegate pays fee and signs
  instructions: [transferInstruction]
});

// =============================================================================
// Fetch Final Token Account Balances
// =============================================================================

const finalSenderToken = await fetchToken(client.runtime.rpc, senderAta);
const finalRecipientToken = await fetchToken(client.runtime.rpc, recipientAta);

console.log("\n=== Transaction 2: Transfer Using Delegate ===");
console.log("Transaction Signature:", transferSignature);
console.log("\nSender Token Account Data:", finalSenderToken.data);
console.log("\nRecipient Token Account Data:", finalRecipientToken.data);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a delegate transfer demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sender and delegate for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token accounts for sender and recipient
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @param delegate - The delegate's keypair (will be funded for transaction fees)
 * @param recipient - The recipient's keypair
 * @returns Returns client instance, mint, and ATA addresses
 */
async function demoSetup(
  sender: ServerKeypair["signer"],
  delegate: ServerKeypair["signer"],
  recipient: ServerKeypair["signer"]
) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sender and delegate with SOL for transaction fees
  await client.actions.requestAirdrop(sender.address, lamports(1_000_000_000n));
  await client.actions.requestAirdrop(
    delegate.address,
    lamports(1_000_000_000n)
  );

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sender,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Derive recipient's associated token account address (ATA)
  const [recipientAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: recipient.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sender,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction for recipient's ATA
  const createRecipientAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sender,
      mint: mint.address,
      owner: recipient.address
    });

  // Create instruction to mint initial tokens to sender
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender.address,
    amount: 2_000_000n // Mint 2.00 tokens (2,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    createRecipientAtaInstruction, // Create recipient's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client
  await client.transaction.prepareAndSend({
    authority: sender,
    instructions: setupInstructions
  });

  return {
    client,
    mint,
    senderAta,
    recipientAta
  };
}
```

</CodeTabs>

## 检查代理状态

查询 token account 以查看其当前代理及剩余额度：

<CodeTabs storage="kit-cli">

```ts !! title="Kit"
import { fetchToken } from "@solana-program/token";

const tokenAccount = await fetchToken(rpc, tokenAccountAddress);

if (tokenAccount.data.delegate) {
  console.log("Delegate:", tokenAccount.data.delegate);
  console.log("Remaining allowance:", tokenAccount.data.delegatedAmount);
} else {
  console.log("No delegate set");
}
```

```bash !! title="CLI"
spl-token display <TOKEN_ACCOUNT>
# Look for "Delegate" and "Delegated Amount" fields
```

</CodeTabs>

### 演示

<CodeTabs flags="r">

```ts !! title="Check Delegation Status"
// !collapse(1:15) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  findAssociatedTokenPda,
  getMintToInstruction,
  getApproveCheckedInstruction,
  fetchToken,
  TOKEN_2022_PROGRAM_ADDRESS
} from "@solana-program/token-2022";

// Demo Setup: Create client, mint, two token accounts (one with delegate, one without)
const { client, ataWithDelegate, ataWithoutDelegate } = await demoSetup();

// =============================================================================
// Fetch Token Accounts
// =============================================================================

// Fetch token account with delegate
// !mark
const tokenWithDelegate = await fetchToken(client.runtime.rpc, ataWithDelegate);
console.log("Token Account with Delegate:", tokenWithDelegate);

// Fetch token account without delegate
// !mark
const tokenWithoutDelegate = await fetchToken(
  client.runtime.rpc,
  ataWithoutDelegate
);
console.log("\nToken Account without Delegate:", tokenWithoutDelegate);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up two token accounts for comparison:
 * - Creates @solana/client instance
 * - Airdrops SOL to owner for transaction fees
 * - Creates mint and two token accounts
 * - Approves delegate on one token account
 *
 * @returns Returns client and both ATA addresses
 */
async function demoSetup() {
  // Generate keypairs
  const owner = (await generateKeypair()).signer;
  const owner2 = (await generateKeypair()).signer;
  const delegate = (await generateKeypair()).signer;

  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund owner with SOL for transaction fees
  await client.actions.requestAirdrop(owner.address, lamports(1_000_000_000n));

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  const createAccountInstruction = getCreateAccountInstruction({
    payer: owner,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: owner.address
  });

  // Derive ATAs for both owners
  const [ataWithDelegate] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: owner.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  const [ataWithoutDelegate] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: owner2.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create ATA instructions
  const createAta1Instruction = await getCreateAssociatedTokenInstructionAsync({
    payer: owner,
    mint: mint.address,
    owner: owner.address
  });

  const createAta2Instruction = await getCreateAssociatedTokenInstructionAsync({
    payer: owner,
    mint: mint.address,
    owner: owner2.address
  });

  // Mint tokens to both ATAs
  const mintTo1Instruction = getMintToInstruction({
    mint: mint.address,
    token: ataWithDelegate,
    mintAuthority: owner.address,
    amount: 1_000_000n // 1.0 tokens
  });

  const mintTo2Instruction = getMintToInstruction({
    mint: mint.address,
    token: ataWithoutDelegate,
    mintAuthority: owner.address,
    amount: 1_000_000n // 1.0 tokens
  });

  // Approve delegate on first ATA
  const approveInstruction = getApproveCheckedInstruction({
    source: ataWithDelegate,
    mint: mint.address,
    delegate: delegate.address,
    owner: owner,
    amount: 500_000n, // 0.5 tokens
    decimals: 6
  });

  // Send setup transaction
  await client.transaction.prepareAndSend({
    authority: owner,
    instructions: [
      createAccountInstruction,
      initializeMintInstruction,
      createAta1Instruction,
      createAta2Instruction,
      mintTo1Instruction,
      mintTo2Instruction,
      approveInstruction
    ]
  });

  return {
    client,
    ataWithDelegate,
    ataWithoutDelegate
  };
}
```

</CodeTabs>

## 安全注意事项

**账户所有者须知：**

- 仅批准可信的代理
- 设置所需的最低支出限额
- 不再需要时及时撤销代理权限
- 监控账户，防止异常转账

**服务提供方（代理）须知：**

- 向用户明确告知所请求的支出限额
- 对代理账户进行妥善的密钥管理
- 跟踪额度消耗情况，额度用尽前及时申请重新授权

## 代理与托管的区别

| 方面         | 代理授权         | 完全托管             |
| ------------ | ---------------- | -------------------- |
| Token 所有权 | 用户保留         | 用户转移给托管方     |
| 支出控制     | 限于批准额度     | 可支配全部已转移资金 |
| 撤销权限     | 所有者可即时撤销 | 需托管方配合         |
| 风险敞口     | 限于批准额度     | 全部余额             |
| 信任要求     | 有限             | 高                   |

代理授权提供了一种折中方式——既能实现自动化支付，又能将风险敞口限制在批准额度内。

## 相关资源

| 资源                                                     | 说明                                     |
| -------------------------------------------------------- | ---------------------------------------- |
| [Approve Delegate](/docs/tokens/basics/approve-delegate) | 如何授权其他账户支配你的 token account。 |
| [Revoke Delegate](/docs/tokens/basics/revoke-delegate)   | 如何移除现有代理并撤销其支出权限。       |
| [Transfer Token](/docs/tokens/basics/transfer-tokens)    | 如何在 token account 之间转账。          |
