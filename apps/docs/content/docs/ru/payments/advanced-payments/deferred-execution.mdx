---
title: Отложенное выполнение
description:
  Подписывайте транзакции сейчас, выполняйте позже — для согласования,
  казначейских операций и безопасного подписания
---

Каждая транзакция в Solana содержит недавний blockhash — ссылку на актуальное
состояние сети, подтверждающую, что транзакция создана «сейчас». Сеть отклоняет
любую транзакцию с blockhash старше примерно 150 блоков (60–90 секунд),
предотвращая повторные атаки и устаревшие отправки. Это отлично работает для
платежей в реальном времени. Но такой подход не подходит для сценариев, где
между подписанием и отправкой требуется пауза, например:

| Сценарий                         | Почему стандартные транзакции не подходят                                          |
| -------------------------------- | ---------------------------------------------------------------------------------- |
| **Казначейские операции**        | CFO в Токио подписывает, контролёр в Нью-Йорке утверждает — 90 секунд недостаточно |
| **Комплаенс-процедуры**          | Транзакции требуют юридической/комплаенс-проверки перед выполнением                |
| **Подпись в холодном хранилище** | Air-gapped устройства требуют ручной передачи подписанных транзакций               |
| **Подготовка пакетов**           | Подготовка зарплаты или выплат в рабочее время, выполнение ночью                   |
| **Координация мультиподписи**    | Несколько утверждающих в разных часовых поясах                                     |
| **Запланированные платежи**      | Платежи, которые должны быть выполнены в будущем                                   |

В традиционных финансах подписанный чек не теряет силу через 90 секунд.
Некоторые операции в блокчейне тоже не должны. **Долговечные nonces** решают эту
задачу, заменяя недавний blockhash на сохранённое, постоянное значение, которое
обновляется только при использовании — так транзакции остаются действительными
до момента отправки.

## Как это работает

Вместо недавнего blockhash (действителен ~150 блоков) используется
**nonce-аккаунт** — специальный аккаунт, в котором хранится _уникальное_
значение. Каждая транзакция с этим nonce должна «продвигать» его первой
инструкцией, предотвращая повторные атаки.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  STANDARD BLOCKHASH                                                         │
│                                                                             │
│    ┌──────┐      ┌──────────┐                                               │
│    │ Sign │ ───▶ │  Submit  │     ⏱️ Must happen within ~90 seconds         │
│    └──────┘      └──────────┘                                               │
│       │                                                                     │
│       └─────────  Transaction expires if not submitted in time              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  DURABLE NONCE                                                              │
│                                                                             │
│    ┌──────┐      ┌───────┐       ┌─────────┐      ┌──────────┐              │
│    │ Sign │ ───▶ │ Store │ ───▶  │ Approve │ ───▶ │  Submit  │              │
│    └──────┘      └───────┘       └─────────┘      └──────────┘              │
│                                                                             │
│    Transaction remains valid until you submit it                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

<Callout type="info">
  Для освобождения от rent nonce-аккаунта требуется примерно 0,0015 SOL. Один
  nonce-аккаунт = одна ожидающая транзакция одновременно. Для параллельных
  процессов создайте несколько nonce-аккаунтов.
</Callout>

## Настройка: создание nonce-аккаунта

Создание nonce-аккаунта требует двух инструкций в одной транзакции:

1. **Создайте аккаунт** с помощью `getCreateAccountInstruction` из System
   Program
2. **Инициализируйте его как nonce** с помощью
   `getInitializeNonceAccountInstruction`

```ts
import { generateKeyPairSigner } from "@solana/kit";
import {
  getNonceSize,
  getCreateAccountInstruction,
  getInitializeNonceAccountInstruction,
  SYSTEM_PROGRAM_ADDRESS
} from "@solana-program/system";

// Generate a keypair for the nonce account address
const nonceKeypair = await generateKeyPairSigner();

// Get required account size for rent calculation
const space = BigInt(getNonceSize());

// 1. Create the account (owned by System Program)
getCreateAccountInstruction({
  payer,
  newAccount: nonceKeypair,
  lamports: rent,
  space,
  programAddress: SYSTEM_PROGRAM_ADDRESS
});

// 2. Initialize as nonce account
getInitializeNonceAccountInstruction({
  nonceAccount: nonceKeypair.address,
  nonceAuthority: authorityAddress // Controls nonce advancement
});

// Assemble and send transaction to the network
```

## Создание отложенной транзакции

Вместо использования недавнего blockhash используйте значение nonce в качестве
срока действия транзакции. Для этого сначала нужно получить значение nonce из
nonce-аккаунта, а затем использовать его для установки срока действия
транзакции.

### Получение значения Nonce

Сначала получите значение nonce из nonce-аккаунта:

```ts
import { fetchNonce } from "@solana-program/system";

const nonceAccount = await fetchNonce(rpc, nonceAddress);
const nonceValue = nonceAccount.data.blockhash; // Use this as your "blockhash"
```

### Установка времени жизни транзакции с помощью nonce

Вместо использования недавнего blockhash, который истекает, используйте
`setTransactionMessageLifetimeUsingDurableNonce`. Эта функция выполняет две
задачи:

1. Устанавливает значение nonce как "blockhash" транзакции
2. Автоматически добавляет инструкцию `advanceNonceAccount` (требуется как
   первая инструкция во всех транзакциях с durable nonce)

```ts
import {
  setTransactionMessageLifetimeUsingDurableNonce,
  type Nonce
} from "@solana/kit";

setTransactionMessageLifetimeUsingDurableNonce(
  {
    nonce: nonceAccount.data.blockhash as Nonce,
    nonceAccountAddress: nonceAddress,
    nonceAuthorityAddress: authorityAddress
  },
  transactionMessage
);
```

## Подпись и сохранение

После сборки подпишите транзакцию и сериализуйте её для хранения:

```ts
import {
  signTransactionMessageWithSigners,
  getBase64EncodedWireTransaction
} from "@solana/kit";

// Sign the transaction
const signedTx = await signTransactionMessageWithSigners(transactionMessage);

// Serialize for storage (database, file, etc.)
const serialized = getBase64EncodedWireTransaction(signedTx);
```

Сохраните сериализованную строку в вашей базе данных — она останется
действительной, пока nonce не будет обновлён.

## Многосторонний процесс согласования

Десериализуйте транзакцию, чтобы добавить дополнительные подписи, затем снова
сериализуйте для хранения или отправки:

```ts
import {
  getBase64Decoder,
  getTransactionDecoder,
  getBase64EncodedWireTransaction,
  partiallySignTransaction
} from "@solana/kit";

// Deserialize the stored transaction
const txBytes = getBase64Decoder().decode(serializedString);
const partiallySignedTx = getTransactionDecoder().decode(txBytes);

// Each approver adds their signature
const fullySignedTx = await partiallySignTransaction(
  [newSigner],
  partiallySignedTx
);

// Serialize again for storage or submission
const serialized = getBase64EncodedWireTransaction(fullySignedTx);
```

Транзакцию можно сериализовать, хранить и передавать между участниками
согласования. После сбора всех необходимых подписей отправьте её в сеть.

## Выполнение после готовности

Когда все согласования завершены, отправьте сериализованную транзакцию в сеть:

```ts
const signature = await rpc
  .sendTransaction(serializedTransaction, { encoding: "base64" })
  .send();
```

<Callout type="caution">
  Каждый nonce можно использовать только один раз. Если транзакция не удалась
  или вы решили её не отправлять, необходимо обновить nonce перед подготовкой
  новой транзакции с тем же nonce-аккаунтом.
</Callout>

## Обновление использованного или устаревшего Nonce

Чтобы аннулировать ожидающую транзакцию или подготовить nonce к повторному
использованию, обновите его вручную:

```ts
import { getAdvanceNonceAccountInstruction } from "@solana-program/system";

// Submit this instruction (with a regular blockhash) to invalidate any pending transaction
getAdvanceNonceAccountInstruction({
  nonceAccount: nonceAddress,
  nonceAuthority
});
```

Это сгенерирует новое значение nonce, делая любую транзакцию, подписанную со
старым значением, навсегда недействительной.

## Вопросы эксплуатации

**Управление nonce-аккаунтами:**

- Создайте пул nonce-аккаунтов для параллельной подготовки транзакций
- Отслеживайте, какие nonces "используются" (имеют неподтверждённые подписанные
  транзакции)
- Реализуйте повторное использование nonces после отправки или отмены транзакций

**Безопасность:**

- Владелец nonce-аккаунта контролирует возможность аннулирования транзакций. Для
  дополнительного контроля и разделения обязанностей рассмотрите возможность
  отделения владельца nonce от подписантов транзакций
- _Любой_, у кого есть сериализованные байты транзакции, может отправить её в
  сеть

## Связанные ресурсы

- [Введение в Durable Nonces](https://solana.com/developers/guides/advanced/introduction-to-durable-nonces)
