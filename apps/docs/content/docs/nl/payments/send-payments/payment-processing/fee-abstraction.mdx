---
title: Fee abstraction
description:
  Leer hoe fee sponsorship werkt en implementeer fee abstraction met Kora.
---

Elke Solana-transactie vereist SOL om netwerkkosten te betalen. Maar gebruikers
die naar jouw betalingsapplicatie komen, verwachten te transacteren in
stablecoins—niet een tweede tokensaldo te beheren. Fee abstraction verwijdert
deze wrijving doordat iemand anders de kosten betaalt.

Deze gids behandelt twee niveaus:

1. **Hoe fee sponsorship werkt** — de onderliggende Solana-primitief
2. **Fee abstraction op schaal met Kora** — een productierijpe fee
   abstraction-service

## Hoe fee sponsorship werkt

Solana-transacties hebben een aangewezen fee payer—het account dat de
netwerkkosten betaalt. Standaard is dit de eerste ondertekenaar. Maar je kunt
een ander account als fee payer specificeren, waardoor een derde partij (de
"sponsor") kosten kan dekken namens de verzender.

Zowel de verzender als de sponsor moeten de transactie ondertekenen:

- De **verzender** ondertekent om de overdracht van hun tokens te autoriseren
- De **sponsor** ondertekent om betaling van de netwerkkosten te autoriseren

<Callout>
  Zie [How Payments Work on Solana](/docs/payments/how-payments-work) voor
  kernconcepten van betalingen.
</Callout>

De onderstaande stappen tonen de kernflow. Zie de [Demo](#demo) voor complete
uitvoerbare code.

<ScrollyCoding>

## !!steps Maak een sponsor-account aan

Genereer een apart keypair voor de sponsor die transactiekosten zal betalen. De
sponsor heeft SOL nodig voor kosten maar hoeft de tokens die worden overgedragen
niet te bezitten.

<CodePlaceholder title="Sponsor transactiekosten" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;
```

## !!steps Maak transfer-instructie aan

Maak de token transfer-instructie aan met de verzender als authority. De
verzender bezit de tokens en moet de overdracht ondertekenen.

<CodePlaceholder title="Sponsor transactiekosten" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

// !focus(1:6)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Sender signs for the transfer
  amount: 250_000n // adjusted for the mint's decimals
});
```

## !!steps Verzenden met sponsor als betaler van kosten

Gebruik `prepareAndSend` met zowel `authority` (de verzender die de overdracht
ondertekent) als `feePayer` (de sponsor die de kosten betaalt). Beiden moeten de
transactie ondertekenen.

<CodePlaceholder title="Sponsor transactiekosten" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender,
  amount: 250_000n
});

// !focus(1:6)
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Signs the transfer instruction
  // !mark
  feePayer: sponsor, // Pays the transaction fees
  instructions: [transferInstruction],
  version: 0
});
```

</ScrollyCoding>

### Demo

<CodeTabs flags="r">

```ts !! title="Demo"
// !collapse(1:14) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  TOKEN_2022_PROGRAM_ADDRESS,
  findAssociatedTokenPda,
  getMintToInstruction,
  getTransferInstruction
} from "@solana-program/token-2022";

// Generate keypairs for sender, recipient, and sponsor (fee payer)
const sender = (await generateKeypair()).signer;
const recipient = (await generateKeypair()).signer;
// !mark
const sponsor = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Recipient Address:", recipient.address);
console.log("Sponsor Address (Fee Payer):", sponsor.address);

// Demo Setup: Create client, mint account, token accounts, and fund with initial tokens
const { client, mint } = await demoSetup(sender, recipient, sponsor);

console.log("\nMint Address:", mint.address);

// Derive the Associated Token Accounts addresses (ATAs) for sender and recipient
const [senderAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: sender.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

const [recipientAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: recipient.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

console.log("Sender Token Account:", senderAta.toString());
console.log("Recipient Token Account:", recipientAta.toString());

// =============================================================================
// Sponsored Token Payment Demo
// =============================================================================

// Create instruction to transfer tokens from sender to recipient
// Transferring 250,000 base units = 0.25 tokens (with 6 decimals)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Pass signer, not just address
  amount: 250_000n // 0.25 tokens
});

// Prepare and send transaction with sponsor as fee payer using @solana/client
// The sponsor pays transaction fees, sender signs for the transfer
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Sender signs the transfer instruction
  // !mark
  feePayer: sponsor, // Sponsor pays the transaction fees (different account)
  instructions: [transferInstruction],
  version: 0
});

console.log("\n=== Sponsored Token Payment Complete ===");
console.log("Transaction Signature:", signature.toString());

// Fetch final token account balances using @solana/client SPL token helper
const splToken = client.splToken({
  mint: mint.address,
  tokenProgram: "auto"
});

const senderBalance = await splToken.fetchBalance(sender.address);
const recipientBalance = await splToken.fetchBalance(recipient.address);

console.log("\nSender Token Account Balance:", senderBalance);
console.log("Recipient Token Account Balance:", recipientBalance);

// Fetch transaction details
const transaction = await client.runtime.rpc
  .getTransaction(signature, {
    encoding: "jsonParsed",
    maxSupportedTransactionVersion: 0
  })
  .send();

const feePayer = transaction?.transaction.message.accountKeys?.[0];
console.log("\nNote: The first account in accountKeys is always the fee payer");
console.log("Fee Payer Address:", feePayer);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a sponsored token transfer demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sponsor for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token accounts for sender and recipient
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @param recipient - The recipient's keypair
 * @param sponsor - The sponsor's keypair (will pay all transaction fees)
 * @returns Returns client instance and mint address
 */
async function demoSetup(
  sender: ServerKeypair["signer"],
  recipient: ServerKeypair["signer"],
  sponsor: ServerKeypair["signer"]
) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sponsor with SOL for transaction fees using @solana/client actions
  await client.actions.requestAirdrop(
    sponsor.address,
    lamports(1_000_000_000n)
  );

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program (sponsor pays the rent)
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sponsor,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA (sponsor pays)
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction for recipient's ATA (sponsor pays)
  const createRecipientAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: recipient.address
    });

  // Create instruction to mint initial tokens to sender
  // Sender is the mint authority and must sign
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender, // Pass signer, not just address
    amount: 1_000_000n // Mint 1.00 tokens (1,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    createRecipientAtaInstruction, // Create recipient's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client with sponsor as fee payer
  await client.transaction.prepareAndSend({
    authority: sender,
    feePayer: sponsor, // Sponsor pays all transaction fees
    instructions: setupInstructions,
    version: 0
  });

  return {
    client,
    mint
  };
}
```

</CodeTabs>

<Callout type="caution">
  Wanneer je een token account aanmaakt voor een eindgebruiker, kunnen ze deze
  sluiten en de SOL die gebruikt is voor rent terugvorderen. Overweeg om
  gebruikers te laten betalen voor het aanmaken van accounts in stablecoins, of
  verwerk deze kosten in je producteconomie.
</Callout>

## Fee-abstractie op schaal met Kora

De fee payer primitive is krachtig, maar het bouwen van een productie-gasless
systeem vereist meer: het beheren van sponsor wallets, het afhandelen van
tokenconversies (zodat gebruikers kosten kunnen "betalen" in USDC), rate
limiting en beveiligingscontroles.

[Kora](https://launch.solana.com/products/kora) handelt deze complexiteit af.
Het is een JSON-RPC server die fee-abstractie biedt zodat gebruikers nooit SOL
nodig hebben. Je kunt kosten volledig sponsoren of betaling accepteren in elke
token.

Deploy Kora met een enkel commando:

```bash
cargo install kora-cli
kora --config path/to/kora.toml rpc start --signers-config path/to/signers.toml
```

Gebruik vervolgens de Kora client om transacties te ondertekenen en te
verzenden:

```bash
pnpm add @solana/kora
```

```typescript
import { KoraClient } from "@solana/kora";

const kora = new KoraClient({ rpcUrl: "https://your-kora-instance" });

const { signature } = await kora.signAndSendTransaction({
  transaction: base64EncodedTransaction
});
```

### Kora-bronnen

<Cards>
  <Card
    title="Kora quick start"
    href="https://launch.solana.com/docs/kora/getting-started/quick-start"
  >
    Krijg Kora binnen enkele minuten lokaal draaiend.
  </Card>
  <Card
    title="Volledige transactie demo"
    href="https://launch.solana.com/docs/kora/guides/full-demo"
  >
    Complete implementatiegids voor fee-abstractie transacties.
  </Card>
  <Card
    title="API-referentie"
    href="https://launch.solana.com/docs/kora/json-rpc-api"
  >
    JSON-RPC methoden en SDK-documentatie.
  </Card>
  <Card
    title="Node operator gids"
    href="https://launch.solana.com/docs/kora/operators"
  >
    Deploy en configureer je eigen Kora-instantie.
  </Card>
</Cards>
