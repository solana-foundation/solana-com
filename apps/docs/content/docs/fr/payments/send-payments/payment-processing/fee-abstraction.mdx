---
title: Abstraction des frais
description:
  Découvrez comment fonctionne le parrainage des frais et implémentez
  l'abstraction des frais avec Kora.
---

Chaque transaction Solana nécessite du SOL pour payer les frais de réseau. Mais
les utilisateurs qui viennent sur votre application de paiement s'attendent à
effectuer des transactions en stablecoins, et non à gérer un solde de second
jeton. L'abstraction des frais élimine cette friction en permettant à quelqu'un
d'autre de payer les frais.

Ce guide couvre deux niveaux :

1. **Comment fonctionne le parrainage des frais** — la primitive Solana
   sous-jacente
2. **Abstraction des frais à grande échelle avec Kora** — un service
   d'abstraction des frais prêt pour la production

## Comment fonctionne le parrainage des frais

Les transactions Solana ont un payeur de frais désigné, c'est-à-dire le compte
qui paie les frais de réseau. Par défaut, il s'agit du premier signataire. Mais
vous pouvez spécifier un compte différent comme payeur de frais, permettant à un
tiers (le « parrain ») de couvrir les frais au nom de l'expéditeur.

L'expéditeur et le parrain doivent tous deux signer la transaction :

- L'**expéditeur** signe pour autoriser le transfert de ses jetons
- Le **parrain** signe pour autoriser le paiement des frais de réseau

<Callout>
  Consultez [Comment fonctionnent les paiements sur
  Solana](/docs/payments/how-payments-work) pour les concepts de paiement de
  base.
</Callout>

Les étapes ci-dessous montrent le flux principal. Consultez la [Démo](#demo)
pour le code complet exécutable.

<ScrollyCoding>

## !!steps Créer un compte parrain

Générez une paire de clés distincte pour le parrain qui paiera les frais de
transaction. Le parrain a besoin de SOL pour les frais mais n'a pas besoin de
détenir les jetons transférés.

<CodePlaceholder title="Parrainer les frais de transaction" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;
```

## !!steps Créer l'instruction de transfert

Créez l'instruction de transfert de jetons avec l'expéditeur comme autorité.
L'expéditeur possède les jetons et doit signer le transfert.

<CodePlaceholder title="Frais de transaction sponsorisés" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

// !focus(1:6)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Sender signs for the transfer
  amount: 250_000n // adjusted for the mint's decimals
});
```

## !!steps Envoyer avec un sponsor comme payeur de frais

Utilisez `prepareAndSend` avec à la fois `authority` (l'expéditeur qui signe le
transfert) et `feePayer` (le sponsor qui paie les frais). Les deux doivent
signer la transaction.

<CodePlaceholder title="Frais de transaction sponsorisés" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender,
  amount: 250_000n
});

// !focus(1:6)
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Signs the transfer instruction
  // !mark
  feePayer: sponsor, // Pays the transaction fees
  instructions: [transferInstruction],
  version: 0
});
```

</ScrollyCoding>

### Démo

<CodeTabs flags="r">

```ts !! title="Demo"
// !collapse(1:14) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  TOKEN_2022_PROGRAM_ADDRESS,
  findAssociatedTokenPda,
  getMintToInstruction,
  getTransferInstruction
} from "@solana-program/token-2022";

// Generate keypairs for sender, recipient, and sponsor (fee payer)
const sender = (await generateKeypair()).signer;
const recipient = (await generateKeypair()).signer;
// !mark
const sponsor = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Recipient Address:", recipient.address);
console.log("Sponsor Address (Fee Payer):", sponsor.address);

// Demo Setup: Create client, mint account, token accounts, and fund with initial tokens
const { client, mint } = await demoSetup(sender, recipient, sponsor);

console.log("\nMint Address:", mint.address);

// Derive the Associated Token Accounts addresses (ATAs) for sender and recipient
const [senderAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: sender.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

const [recipientAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: recipient.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

console.log("Sender Token Account:", senderAta.toString());
console.log("Recipient Token Account:", recipientAta.toString());

// =============================================================================
// Sponsored Token Payment Demo
// =============================================================================

// Create instruction to transfer tokens from sender to recipient
// Transferring 250,000 base units = 0.25 tokens (with 6 decimals)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Pass signer, not just address
  amount: 250_000n // 0.25 tokens
});

// Prepare and send transaction with sponsor as fee payer using @solana/client
// The sponsor pays transaction fees, sender signs for the transfer
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Sender signs the transfer instruction
  // !mark
  feePayer: sponsor, // Sponsor pays the transaction fees (different account)
  instructions: [transferInstruction],
  version: 0
});

console.log("\n=== Sponsored Token Payment Complete ===");
console.log("Transaction Signature:", signature.toString());

// Fetch final token account balances using @solana/client SPL token helper
const splToken = client.splToken({
  mint: mint.address,
  tokenProgram: "auto"
});

const senderBalance = await splToken.fetchBalance(sender.address);
const recipientBalance = await splToken.fetchBalance(recipient.address);

console.log("\nSender Token Account Balance:", senderBalance);
console.log("Recipient Token Account Balance:", recipientBalance);

// Fetch transaction details
const transaction = await client.runtime.rpc
  .getTransaction(signature, {
    encoding: "jsonParsed",
    maxSupportedTransactionVersion: 0
  })
  .send();

const feePayer = transaction?.transaction.message.accountKeys?.[0];
console.log("\nNote: The first account in accountKeys is always the fee payer");
console.log("Fee Payer Address:", feePayer);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a sponsored token transfer demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sponsor for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token accounts for sender and recipient
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @param recipient - The recipient's keypair
 * @param sponsor - The sponsor's keypair (will pay all transaction fees)
 * @returns Returns client instance and mint address
 */
async function demoSetup(
  sender: ServerKeypair["signer"],
  recipient: ServerKeypair["signer"],
  sponsor: ServerKeypair["signer"]
) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sponsor with SOL for transaction fees using @solana/client actions
  await client.actions.requestAirdrop(
    sponsor.address,
    lamports(1_000_000_000n)
  );

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program (sponsor pays the rent)
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sponsor,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA (sponsor pays)
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction for recipient's ATA (sponsor pays)
  const createRecipientAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: recipient.address
    });

  // Create instruction to mint initial tokens to sender
  // Sender is the mint authority and must sign
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender, // Pass signer, not just address
    amount: 1_000_000n // Mint 1.00 tokens (1,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    createRecipientAtaInstruction, // Create recipient's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client with sponsor as fee payer
  await client.transaction.prepareAndSend({
    authority: sender,
    feePayer: sponsor, // Sponsor pays all transaction fees
    instructions: setupInstructions,
    version: 0
  });

  return {
    client,
    mint
  };
}
```

</CodeTabs>

<Callout type="caution">
  Lorsque vous créez un token account pour un utilisateur final, il peut le
  fermer et récupérer les SOL utilisés pour le rent. Envisagez de facturer les
  utilisateurs pour la création de compte en stablecoins, ou intégrez ce coût
  dans l'économie de votre produit.
</Callout>

## Abstraction des frais à grande échelle avec Kora

La primitive du payeur de frais est puissante, mais construire un système sans
frais en production nécessite davantage : gérer les portefeuilles sponsors,
gérer les conversions de tokens (pour que les utilisateurs puissent « payer »
les frais en USDC), limiter le débit et mettre en place des contrôles de
sécurité.

[Kora](https://launch.solana.com/products/kora) gère cette complexité. C'est un
serveur JSON-RPC qui fournit une abstraction des frais afin que les utilisateurs
n'aient jamais besoin de SOL. Vous pouvez entièrement sponsoriser les frais ou
accepter le paiement des frais dans n'importe quel token.

Déployez Kora avec une seule commande :

```bash
cargo install kora-cli
kora --config path/to/kora.toml rpc start --signers-config path/to/signers.toml
```

Ensuite, utilisez le client Kora pour signer et envoyer des transactions :

```bash
pnpm add @solana/kora
```

```typescript
import { KoraClient } from "@solana/kora";

const kora = new KoraClient({ rpcUrl: "https://your-kora-instance" });

const { signature } = await kora.signAndSendTransaction({
  transaction: base64EncodedTransaction
});
```

### Ressources Kora

<Cards>
  <Card
    title="Démarrage rapide Kora"
    href="https://launch.solana.com/docs/kora/getting-started/quick-start"
  >
    Lancez Kora localement en quelques minutes.
  </Card>
  <Card
    title="Démo de transaction complète"
    href="https://launch.solana.com/docs/kora/guides/full-demo"
  >
    Guide complet d'implémentation de transaction avec abstraction des frais.
  </Card>
  <Card
    title="Référence API"
    href="https://launch.solana.com/docs/kora/json-rpc-api"
  >
    Documentation des méthodes JSON-RPC et du SDK.
  </Card>
  <Card
    title="Guide de l'opérateur de nœud"
    href="https://launch.solana.com/docs/kora/operators"
  >
    Déployez et configurez votre propre instance Kora.
  </Card>
</Cards>
