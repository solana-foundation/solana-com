---
title: Astrazione delle commissioni
description:
  Scopri come funziona la sponsorizzazione delle commissioni e implementa
  l'astrazione delle commissioni con Kora.
---

Ogni transazione Solana richiede SOL per pagare le commissioni di rete. Ma gli
utenti che arrivano alla tua applicazione di pagamento si aspettano di
effettuare transazioni in stablecoin, non di gestire un secondo saldo di token.
L'astrazione delle commissioni elimina questo attrito facendo pagare le
commissioni a qualcun altro.

Questa guida copre due livelli:

1. **Come funziona la sponsorizzazione delle commissioni** — la primitiva
   sottostante di Solana
2. **Astrazione delle commissioni su larga scala con Kora** — un servizio di
   astrazione delle commissioni pronto per la produzione

## Come funziona la sponsorizzazione delle commissioni

Le transazioni Solana hanno un pagatore di commissioni designato, l'account che
paga la commissione di rete. Per impostazione predefinita, questo è il primo
firmatario. Ma puoi specificare un account diverso come pagatore delle
commissioni, consentendo a una terza parte (lo "sponsor") di coprire le
commissioni per conto del mittente.

Sia il mittente che lo sponsor devono firmare la transazione:

- Il **mittente** firma per autorizzare il trasferimento dei propri token
- Lo **sponsor** firma per autorizzare il pagamento della commissione di rete

<Callout>
  Vedi [Come funzionano i pagamenti su Solana](/docs/payments/how-payments-work)
  per i concetti fondamentali sui pagamenti.
</Callout>

I passaggi seguenti mostrano il flusso principale. Vedi la [Demo](#demo) per il
codice completo eseguibile.

<ScrollyCoding>

## !!steps Crea un account sponsor

Genera una keypair separata per lo sponsor che pagherà le commissioni di
transazione. Lo sponsor ha bisogno di SOL per le commissioni ma non deve
detenere i token che vengono trasferiti.

<CodePlaceholder title="Sponsor Transaction Fee" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;
```

## !!steps Crea l'istruzione di trasferimento

Crea l'istruzione di trasferimento dei token con il mittente come autorità. Il
mittente possiede i token e deve firmare il trasferimento.

<CodePlaceholder title="Commissione di transazione sponsorizzata" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

// !focus(1:6)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Sender signs for the transfer
  amount: 250_000n // adjusted for the mint's decimals
});
```

## !!steps Invia con lo sponsor come pagatore delle commissioni

Usa `prepareAndSend` con entrambi `authority` (il mittente che firma il
trasferimento) e `feePayer` (lo sponsor che paga le commissioni). Entrambi
devono firmare la transazione.

<CodePlaceholder title="Commissione di transazione sponsorizzata" />

```ts !! title="Sponsor Transaction Fee"
const sponsor = (await generateKeypair()).signer;

const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender,
  amount: 250_000n
});

// !focus(1:6)
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Signs the transfer instruction
  // !mark
  feePayer: sponsor, // Pays the transaction fees
  instructions: [transferInstruction],
  version: 0
});
```

</ScrollyCoding>

### Demo

<CodeTabs flags="r">

```ts !! title="Demo"
// !collapse(1:14) collapsed
// Click ">" icon on left to expand demo imports
import { createClient, lamports } from "@solana/client";
import { generateKeypair } from "@solana/client/server";
import type { ServerKeypair } from "@solana/client/server";
import { getCreateAccountInstruction } from "@solana-program/system";
import {
  getCreateAssociatedTokenInstructionAsync,
  getInitializeMintInstruction,
  getMintSize,
  TOKEN_2022_PROGRAM_ADDRESS,
  findAssociatedTokenPda,
  getMintToInstruction,
  getTransferInstruction
} from "@solana-program/token-2022";

// Generate keypairs for sender, recipient, and sponsor (fee payer)
const sender = (await generateKeypair()).signer;
const recipient = (await generateKeypair()).signer;
// !mark
const sponsor = (await generateKeypair()).signer;

console.log("Sender Address:", sender.address);
console.log("Recipient Address:", recipient.address);
console.log("Sponsor Address (Fee Payer):", sponsor.address);

// Demo Setup: Create client, mint account, token accounts, and fund with initial tokens
const { client, mint } = await demoSetup(sender, recipient, sponsor);

console.log("\nMint Address:", mint.address);

// Derive the Associated Token Accounts addresses (ATAs) for sender and recipient
const [senderAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: sender.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

const [recipientAta] = await findAssociatedTokenPda({
  mint: mint.address,
  owner: recipient.address,
  tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
});

console.log("Sender Token Account:", senderAta.toString());
console.log("Recipient Token Account:", recipientAta.toString());

// =============================================================================
// Sponsored Token Payment Demo
// =============================================================================

// Create instruction to transfer tokens from sender to recipient
// Transferring 250,000 base units = 0.25 tokens (with 6 decimals)
const transferInstruction = getTransferInstruction({
  source: senderAta,
  destination: recipientAta,
  authority: sender, // Pass signer, not just address
  amount: 250_000n // 0.25 tokens
});

// Prepare and send transaction with sponsor as fee payer using @solana/client
// The sponsor pays transaction fees, sender signs for the transfer
const signature = await client.transaction.prepareAndSend({
  authority: sender, // Sender signs the transfer instruction
  // !mark
  feePayer: sponsor, // Sponsor pays the transaction fees (different account)
  instructions: [transferInstruction],
  version: 0
});

console.log("\n=== Sponsored Token Payment Complete ===");
console.log("Transaction Signature:", signature.toString());

// Fetch final token account balances using @solana/client SPL token helper
const splToken = client.splToken({
  mint: mint.address,
  tokenProgram: "auto"
});

const senderBalance = await splToken.fetchBalance(sender.address);
const recipientBalance = await splToken.fetchBalance(recipient.address);

console.log("\nSender Token Account Balance:", senderBalance);
console.log("Recipient Token Account Balance:", recipientBalance);

// Fetch transaction details
const transaction = await client.runtime.rpc
  .getTransaction(signature, {
    encoding: "jsonParsed",
    maxSupportedTransactionVersion: 0
  })
  .send();

const feePayer = transaction?.transaction.message.accountKeys?.[0];
console.log("\nNote: The first account in accountKeys is always the fee payer");
console.log("Fee Payer Address:", feePayer);

// =============================================================================
// Demo Setup Helper Function
// =============================================================================
// !collapse(1:1000) collapsed

/**
 * Sets up for a sponsored token transfer demo:
 * - Creates @solana/client instance
 * - Airdrops SOL to sponsor for transaction fees
 * - Generates mint keypair and creates/initializes mint account
 * - Creates associated token accounts for sender and recipient
 * - Mints initial tokens to sender
 *
 * @param sender - The sender's keypair (will be funded and used as mint authority)
 * @param recipient - The recipient's keypair
 * @param sponsor - The sponsor's keypair (will pay all transaction fees)
 * @returns Returns client instance and mint address
 */
async function demoSetup(
  sender: ServerKeypair["signer"],
  recipient: ServerKeypair["signer"],
  sponsor: ServerKeypair["signer"]
) {
  // Create @solana/client instance pointing to local validator
  const client = createClient({
    endpoint: "http://localhost:8899",
    websocketEndpoint: "ws://localhost:8900",
    commitment: "confirmed",
    logger: () => {} // Disable all logs
  });

  // Fund sponsor with SOL for transaction fees using @solana/client actions
  await client.actions.requestAirdrop(
    sponsor.address,
    lamports(1_000_000_000n)
  );

  // Generate keypair to use as address of mint
  const mint = (await generateKeypair()).signer;

  // Get default mint account size (in bytes), no extensions enabled
  const space = BigInt(getMintSize());

  // Get minimum balance for rent exemption
  const rent = await client.runtime.rpc
    .getMinimumBalanceForRentExemption(space)
    .send();

  // Instruction to create new account for mint (token program)
  // Invokes the system program (sponsor pays the rent)
  const createAccountInstruction = getCreateAccountInstruction({
    payer: sponsor,
    newAccount: mint,
    lamports: rent,
    space,
    programAddress: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Instruction to initialize mint account data
  // Invokes the token 2022 program
  const initializeMintInstruction = getInitializeMintInstruction({
    mint: mint.address,
    decimals: 6,
    mintAuthority: sender.address
  });

  // Derive sender's associated token account address (ATA)
  const [senderAta] = await findAssociatedTokenPda({
    mint: mint.address,
    owner: sender.address,
    tokenProgram: TOKEN_2022_PROGRAM_ADDRESS
  });

  // Create instruction for sender's ATA (sponsor pays)
  const createSenderAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: sender.address
    });

  // Create instruction for recipient's ATA (sponsor pays)
  const createRecipientAtaInstruction =
    await getCreateAssociatedTokenInstructionAsync({
      payer: sponsor,
      mint: mint.address,
      owner: recipient.address
    });

  // Create instruction to mint initial tokens to sender
  // Sender is the mint authority and must sign
  const mintToInstruction = getMintToInstruction({
    mint: mint.address,
    token: senderAta,
    mintAuthority: sender, // Pass signer, not just address
    amount: 1_000_000n // Mint 1.00 tokens (1,000,000 base units with 6 decimals)
  });

  // Combine all instructions and send using @solana/client transaction helper
  const setupInstructions = [
    createAccountInstruction, // Create mint account
    initializeMintInstruction, // Initialize mint
    createSenderAtaInstruction, // Create sender's ATA
    createRecipientAtaInstruction, // Create recipient's ATA
    mintToInstruction // Mint tokens to sender
  ];

  // Prepare and send transaction using @solana/client with sponsor as fee payer
  await client.transaction.prepareAndSend({
    authority: sender,
    feePayer: sponsor, // Sponsor pays all transaction fees
    instructions: setupInstructions,
    version: 0
  });

  return {
    client,
    mint
  };
}
```

</CodeTabs>

<Callout type="caution">
  Quando crei un token account per un utente finale, questi può chiuderlo e
  recuperare i SOL utilizzati per il rent. Considera di addebitare agli utenti
  la creazione dell'account in stablecoin, oppure includi questo costo
  nell'economia del tuo prodotto.
</Callout>

## Astrazione delle commissioni su larga scala con Kora

La primitiva del pagatore delle commissioni è potente, ma costruire un sistema
gasless in produzione richiede di più: gestire i wallet degli sponsor, gestire
le conversioni di token (in modo che gli utenti possano "pagare" le commissioni
in USDC), limitazione della frequenza e controlli di sicurezza.

[Kora](https://launch.solana.com/products/kora) gestisce questa complessità. È
un server JSON-RPC che fornisce l'astrazione delle commissioni in modo che gli
utenti non abbiano mai bisogno di SOL. Puoi sponsorizzare completamente le
commissioni o accettare il pagamento delle commissioni in qualsiasi token.

Distribuisci Kora con un singolo comando:

```bash
cargo install kora-cli
kora --config path/to/kora.toml rpc start --signers-config path/to/signers.toml
```

Quindi usa il client Kora per firmare e inviare transazioni:

```bash
pnpm add @solana/kora
```

```typescript
import { KoraClient } from "@solana/kora";

const kora = new KoraClient({ rpcUrl: "https://your-kora-instance" });

const { signature } = await kora.signAndSendTransaction({
  transaction: base64EncodedTransaction
});
```

### Risorse Kora

<Cards>
  <Card
    title="Guida rapida Kora"
    href="https://launch.solana.com/docs/kora/getting-started/quick-start"
  >
    Metti in funzione Kora localmente in pochi minuti.
  </Card>
  <Card
    title="Demo completa delle transazioni"
    href="https://launch.solana.com/docs/kora/guides/full-demo"
  >
    Guida completa all'implementazione delle transazioni con astrazione delle
    commissioni.
  </Card>
  <Card
    title="Riferimento API"
    href="https://launch.solana.com/docs/kora/json-rpc-api"
  >
    Metodi JSON-RPC e documentazione SDK.
  </Card>
  <Card
    title="Guida per operatori di nodi"
    href="https://launch.solana.com/docs/kora/operators"
  >
    Distribuisci e configura la tua istanza Kora.
  </Card>
</Cards>
