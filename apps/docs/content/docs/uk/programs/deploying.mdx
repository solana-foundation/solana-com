---
title: Розгортання програм
description:
  Завантаження користувацьких програм у блокчейн Solana за допомогою Solana CLI.
---

Цей посібник передбачає знання наступних тем:

- [Модель облікових записів Solana](/core/accounts)
- [Програми Solana загалом](/core/programs)
- [Розробка користувацьких програм Solana](/programs/rust/)

| Завдання                             | Команда                                                                                       |
| ------------------------------------ | --------------------------------------------------------------------------------------------- |
| Зібрати програму                     | `cargo build-sbf`                                                                             |
| Розгорнути нову програму             | `solana program deploy <path_to_program.so>`                                                  |
| Оновити існуючу програму             | `solana program deploy <path_to_program.so>` (те саме, що й розгортання)                      |
| Показати інформацію про програму     | `solana program show <program-id>`                                                            |
| Передати права на програму           | `solana program set-upgrade-authority <program-id> --new-upgrade-authority <path_to_keypair>` |
| Зробити програму незмінною           | `solana program set-upgrade-authority <program-id> --final`                                   |
| Закрити програму                     | `solana program close <program-id> --bypass-warning`                                          |
| Перевірити баланс гаманця            | `solana balance`                                                                              |
| Запросити airdrop (devnet/localhost) | `solana airdrop 2`                                                                            |

Наразі відбувається перехід від loader-v3 (підкоманда program) до loader-v4
(підкоманда program **-v4**), оскільки loader-v3 застарів.

Для нових розгортань використовуйте `solana program-v4 deploy` замість
`solana program deploy`.

Щоб перенести наявну програму (що по суті є її повторним розгортанням):

```shell
solana program migrate ./target/deploy/your_program-keypair.json
```

## Підготовка

Спочатку програму потрібно зібрати (скомпілювати, зв'язати, очистити).

```shell
cargo +solana build --target sbpf-solana-solana --release
```

Цей крок потрібно виконувати перед кожним повторним розгортанням.

Перевірте, чи достатньо коштів на обліковому записі платника за замовчуванням
пропорційно розміру виконуваного файлу:

```shell
du -h ./target/deploy/your_program.so
solana balance
```

Крім того, кожна програма має обліковий запис програми та ідентифікатор
програми, який є адресою цього облікового запису програми. Наступна команда
генерує keypair для облікового запису програми:

```shell
solana-keygen new -o ./target/deploy/your_program-keypair.json
```

```terminal
$ solana-keygen new
```

Це створює keypair за адресою `~/.config/solana/id.json` за замовчуванням.

```shell
cargo-build-sbf
```

## Початкове розгортання

Тепер виконуваний файл можна завантажити в обліковий запис програми:

Виберіть, на який кластер Solana розгортати. Використовуйте команду
`solana config get`, щоб перевірити вашу поточну конфігурацію:

```terminal
$ solana config get
Config File: ~/.config/solana/cli/config.yml
RPC URL: http://localhost:8899
WebSocket URL: ws://localhost:8900/ (computed)
Keypair Path: ~/.config/solana/id.json
Commitment: confirmed
```

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

```terminal
$ solana config set --url mainnet-beta
$ solana config set --url devnet
$ solana config set --url localhost
$ solana config set --url testnet
$ solana config set --url "https://your-rpc-url.com"
```

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-keypair ./target/deploy/your_program-keypair.json
```

## Повторне розгортання

Завантаження іншого виконуваного файлу до того самого program account знову
перезапише / замінить його. Однак для повторних розгортань потрібен лише
ідентифікатор програми (pubkey програмної keypair), а не вся keypair, оскільки
підписантом є keypair органу оновлення.

### Loader-v3

Для devnet або localhost поповніть свій гаманець за допомогою команди
`solana airdrop`:

```terminal
$ solana airdrop 2
Requesting airdrop of 2 SOL
Signature: 5zQKxvRdgJDA8fRGPdKfGxRLnLpwmNnMXGYxfBqFSUPqc5BTmFPrTG8vnC4HvKDVY8zQ8aQxZxcEE7WFpGhZGVAA
2 SOL
```

Якщо старий виконуваний файл був коротшим за новий, може знадобитися спочатку
збільшити розмір programdata account:

```terminal
$ solana balance
2 SOL
```

### Loader-v4

Зверніть увагу, що початкове розгортання використовувало `program-keypair`, тоді
як повторне розгортання використовує `program-id` замість цього:

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

## Пріоритезація завантаження

Щоб зібрати програму, використовуйте команду `cargo build-sbf`:

```terminal
$ cargo build-sbf
```

## Відновлення завантаження

Можливо, що завантаження застрягне або буде перервано.

### Loader-v3

Якщо розгортання програми не вдається, залишиться проміжний буферний акаунт із
ненульовим балансом. Щоб повернути цей баланс, ви можете відновити невдале
розгортання, надавши той самий проміжний буфер для нового виклику `deploy`.

```rs !! title="src/lib.rs"
use solana_program::{
    account_info::AccountInfo, entrypoint, entrypoint::ProgramResult, msg, pubkey::Pubkey,
};

entrypoint!(process_instruction);

pub fn process_instruction(
    _program_id: &Pubkey,
    _accounts: &[AccountInfo],
    _instruction_data: &[u8],
) -> ProgramResult {
    msg!("Hello, Solana!");
    Ok(())
}
```

```toml !! title="Cargo.toml"
[package]
name = "hello_world"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "lib"]

[dependencies]
solana-program = "2.2.0"
```

Щоб відновити keypair:

Зберіть вашу програму за допомогою команди `cargo build-sbf`:

```terminal
$ cargo build-sbf
```

Це створює два важливі файли в `target/deploy/`:

1. `hello_world-keypair.json`: файл keypair, публічний ключ якого буде
   використовуватися як ваш ідентифікатор програми
2. `hello_world.so`: скомпільований виконуваний файл програми

```json !! title="target/deploy/hello_world-keypair.json"
[
  203, 253, 43, 62, 165, 111, 94, 222, 105, 225, 218, 85, 143, 9, 114, 96, 243,
  181, 114, 89, 72, 230, 124, 85, 59, 165, 198, 23, 240, 212, 23, 154, 229, 241,
  153, 61, 153, 105, 79, 204, 193, 163, 33, 65, 82, 183, 49, 240, 224, 137, 248,
  24, 128, 25, 192, 197, 118, 235, 239, 67, 85, 156, 219, 231
]
```

```txt !! title="target/deploy/hello_world.so"
[binary executable file]
```

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json --start-offset <BYTES_UPLOADED_SO_FAR>
```

## Фіналізація

Це **незворотна** дія.

Програму можна зробити незмінною, видаливши її повноваження на оновлення.

```terminal
$ wc -c < ./target/deploy/hello_world.so
18504
```

```shell
solana program set-upgrade-authority ./target/deploy/your_program-keypair.json --final
```

```terminal
$ solana rent 18504
Rent-exempt minimum: 0.12967872 SOL
```

```shell
solana program finalize --program-id ./target/deploy/your_program-keypair.json
```

Замість перезапису програм також можна надати користувачам вибір, яку версію
програми вони хочуть використовувати, створивши зв'язаний список фіналізованих
програм:

Використовуйте команду `solana program deploy`, щоб розгорнути вашу програму:

```terminal
$ solana program deploy ./target/deploy/hello_world.so
Program Id: 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
Signature: 2BYwsqRP7ZwBNQvJp3S8bphTJ4zKW5JBPVMqCTE5KyLkP8xHzAyUEeC4LdTgjJdGBKHWNCkRF8Mf1T1WkLFyEu8W
```

Для програм, розгорнутих під loader-v3, можна повернути лише їхній programdata
account, буферні акаунти та кошти, заблоковані в них. Program account разом з
ідентифікатором програми та коштами, заблокованими конкретно в program account,
залишаються недоступними.

Програми, розгорнуті під loader-v4, можуть бути закриті разом з їхнім програмним
обліковим записом, їхнім ідентифікатором програми та заблокованими коштами, які
знову стають доступними для інших використань.

### Loader-v3

```terminal
$ solana program deploy ./target/deploy/hello_world.so --program-id ./custom-keypair.json
```

Ви можете генерувати нові keypair за допомогою команди `solana-keygen`:

```terminal
$ solana-keygen new -o ./custom-keypair.json
```

```shell
solana program close ./target/deploy/your_program-keypair.json
```

Щоб закрити всі буферні облікові записи, пов'язані з поточним повноваженням:

Оновіть вашу програму, використовуючи ту саму команду `solana program deploy`:

1. Внесіть зміни до коду вашої програми
2. Перезберіть вашу програму: `cargo build-sbf`
3. Розгорніть оновлення:

```terminal
$ solana program deploy ./target/deploy/hello_world.so
Program Id: 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
Signature: 3zKnXDfEm1R8hVcEmTnNFYUaFjVVbLJrKdFj5hBMXoBRfz8xGyDhCYgKr9YY5KxKYPEUQQVfwEPNz9hQGvYhLNBJ
```

## Перегляд метаданих

Підкоманда `show` виводить метадані програми.

Приклад виводу виглядає так:

```terminal
$ solana program extend 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE 1000
Extended Program Id 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE by 1000 bytes
```

- `Program Id` — це адреса, на яку можна посилатися в полі `program_id`
  інструкції під час виклику програми.
- `Owner`: завантажувач, за допомогою якого була розгорнута ця програма.
- `ProgramData Address` — це programdata account, пов'язаний з обліковим записом
  програми, який містить виконуваний файл програми (тільки для loader-v3).
- `Status`: `retracted`, `deployed` або `finalized` (тільки для loader-v4).
- `Authority` — це повноваження на оновлення програми.
- `Last Deployed In Slot` — це slot, у якому програма була востаннє розгорнута.
- `Data Length` — це розмір простору, зарезервованого для розгортань. Фактичний
  простір, який використовується поточно розгорнутою програмою, може бути
  меншим.

### Loader-v3

Щоб переглянути конкретну програму:

```shell
solana program show ./target/deploy/your_program-keypair.json
```

Щоб перевірити метадані вашої програми, використовуйте команду
`solana program show`:

```terminal
$ solana program show 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
```

Щоб показати всі буферні облікові записи незалежно від повноваження:

```shell
solana program show --buffers --all
```

```txt
$ solana program show 7283x8k8fyBcfaFLyPsxbd2VV1AMmZFP7FNoyTXVKJw7
# !tooltip[/Program Id/] program-id
Program Id: 7283x8k8fyBcfaFLyPsxbd2VV1AMmZFP7FNoyTXVKJw7
# !tooltip[/Owner/] owner
Owner: BPFLoaderUpgradeab1e11111111111111111111111
# !tooltip[/ProgramData Address/] program-data-address
ProgramData Address: Gqn7YQVCP8NtYV1qkEqR4Udhj8EJ3fkikvS7HskCNQ7c
# !tooltip[/Authority/] authority
Authority: 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1
# !tooltip[/Last Deployed In Slot/] last-deployed-in-slot
Last Deployed In Slot: 6573
# !tooltip[/Data Length/] data-length
Data Length: 18504 (0x4848) bytes
# !tooltip[/Balance/] balance
Balance: 0.12999192 SOL
```

```shell
solana program show --programs --buffer-authority ~/.config/solana/authority-keypair.json
solana program show --buffers --buffer-authority ~/.config/solana/authority-keypair.json
```

### Loader-v4

Щоб переглянути конкретну програму:

```shell
solana program-v4 show --program-id ./target/deploy/your_program-keypair.json
```

Щоб переглянути список програм, розгорнутих з authority за замовчуванням:

```shell
solana program-v4 show --all
```

Щоб переглянути список програм, розгорнутих з конкретним authority:

```shell
solana program-v4 show --authority ~/.config/solana/authority-keypair.json
```

## Завантаження виконуваного файлу

Іноді корисно завантажити та порівняти програму, щоб переконатися, що вона
містить відомий виконуваний файл. Завантажений файл можна обрізати, хешувати та
порівняти з хешем оригінального файлу програми.

### Loader-v3

```shell
solana program dump ./target/deploy/your_program-keypair.json ./target/deploy/your_program.so
```

### Loader-v4

```shell
solana program download ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

## Розширені можливості: передача прав власності

Право змінювати певну програму належить її authority. Цей authority можна
передати іншій keypair без зміни keypair програми, щоб ідентифікатор програми
залишався незмінним. Крім того, один authority може контролювати кілька program
account.

Щоб передати повноваження програми іншому акаунту, використовуйте команду
`solana program set-upgrade-authority`:

```terminal
$ solana program set-upgrade-authority 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --new-upgrade-authority ./new-authority-keypair.json
```

Спочатку потрібно згенерувати keypair для authority:

```shell
solana-keygen new -o ~/.config/solana/authority-keypair.json
```

Щоб зробити вашу програму незмінною, використовуйте команду
`solana program set-upgrade-authority` з прапорцем `--final`, щоб видалити
повноваження програми:

```terminal
$ solana program set-upgrade-authority 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --final
Account Type: Program
Authority: none
```

```shell
solana program deploy ./target/deploy/your_program.so --upgrade-authority ~/.config/solana/authority-keypair.json
```

Або після розгортання та використання keypair за замовчуванням як поточного
authority:

Щоб закрити вашу програму та повернути SOL, виділений для program account,
використовуйте команду `solana program close`:

```terminal
$ solana program close 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --bypass-warning
Closed Program Id 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE, 0.12999192 SOL reclaimed
```

```shell
solana program set-upgrade-authority ./target/deploy/your_program-keypair.json --upgrade-authority ~/.config/solana/authority-keypair.json --new-upgrade-authority ~/.config/solana/new_authority-keypair.json
```

### Loader-v4

Повноваження можна вказати під час розгортання:

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-keypair ./target/deploy/your_program-keypair.json --authority ~/.config/solana/authority-keypair.json
```

```terminal
$ solana program show --programs
```

```shell
solana program-v4 transfer-authority --program-id ./target/deploy/your_program-keypair.json --new-authority ~/.config/solana/authority-keypair.json
```

```txt
Program Id                                       | Slot       | Authority                                      | Balance
-------------------------------------------------|------------|------------------------------------------------|-------------
7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE     | 249885434  | 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1   | 0.12999192
3KSGCk4m5hqJkTjPHBXUCPcqMwJnK3VmkqEsFUKKGJPK     | 249883212  | 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1   | 0.28654328
```

```shell
solana program-v4 transfer-authority --program-id ./target/deploy/your_program-keypair.json --authority ~/.config/solana/authority-keypair.json --new-authority ~/.config/solana/new_authority-keypair.json
```

Щоб завантажити розгорнуту програму, використовуйте команду
`solana program dump`:

```terminal
$ solana program dump 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE ./downloaded_program.so
Wrote program to ./downloaded_program.so
```

Майте на увазі, що використання буферних акаунтів приблизно подвоює кошти,
необхідні під час процесу завантаження, оскільки два акаунти одночасно містять
по одному виконуваному файлу.

Спочатку потрібно створити keypair для буферного акаунта:

```shell
solana-keygen new -o ~/.config/solana/buffer-keypair.json
```

Буферний акаунт можна повторно використовувати для різних завантажень, і він не
прив'язаний до жодного конкретного program account.

```terminal
$ solana program deploy ./target/deploy/hello_world.so \
    --with-compute-unit-price 10000 \
    --max-sign-attempts 10 \
    --use-rpc
```

```shell
solana program write-buffer ./target/deploy/your_program.so --buffer ~/.config/solana/buffer-keypair.json
solana program deploy --program-id ./target/deploy/your_program-keypair.json --buffer ~/.config/solana/buffer-keypair.json
```

- **`--with-compute-unit-price`**: встановлює пріоритетну комісію в
  мікролампортах (0,000001 SOL) за одиницю обчислень. Перевірте
  [Helius Priority Fee API](https://docs.helius.dev/guides/priority-fee-api) для
  поточних тарифів. Пріоритетна комісія — це додаткова комісія, яка сплачується
  поточному лідеру для пріоритизації вашої транзакції.
- **`--max-sign-attempts`**: кількість спроб повтору з новим блокхешем, якщо
  транзакції застаріють. (За замовчуванням: 5)
- **`--use-rpc`**: надсилає транзакції до налаштованого RPC. Цей прапорець
  вимагає [stake-weighted](/developers/guides/advanced/stake-weighted-qos)
  RPC-з'єднання від провайдерів, таких як [Triton](https://triton.one/) або
  [Helius](https://www.helius.dev/).
