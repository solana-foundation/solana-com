---
title: Execução diferida
description:
  Assine transações agora, execute depois—permitindo fluxos de aprovação,
  operações de tesouraria e assinatura segura
---

Cada transação Solana inclui um blockhash recente—uma referência a um estado
recente da rede que prova que a transação foi criada "agora". A rede rejeita
qualquer transação com um blockhash mais antigo que ~150 blocos (~60-90
segundos), prevenindo ataques de repetição e submissões obsoletas. Isto funciona
perfeitamente para pagamentos em tempo real. Mas quebra fluxos de trabalho que
precisam de um intervalo entre assinatura e submissão, tais como:

| Cenário                              | Por que transações padrão falham                                                       |
| ------------------------------------ | -------------------------------------------------------------------------------------- |
| **Operações de tesouraria**          | CFO em Tóquio assina, Controller em NYC aprova—90 segundos não são suficientes         |
| **Fluxos de conformidade**           | Transações precisam de revisão legal/conformidade antes da execução                    |
| **Assinatura em armazenamento frio** | Máquinas isoladas requerem transferência manual de transações assinadas                |
| **Preparação em lote**               | Preparar folha de pagamento ou desembolsos durante horário comercial, executar à noite |
| **Coordenação multi-assinatura**     | Múltiplos aprovadores em fusos horários diferentes                                     |
| **Pagamentos agendados**             | Agendar pagamentos para serem executados numa data futura                              |

Nas finanças tradicionais, um cheque assinado não expira em 90 segundos. Certas
operações blockchain também não deveriam. **Nonces duráveis** resolvem isto
substituindo o blockhash recente por um valor armazenado e persistente que só
avança quando você o usa—dando-lhe transações que permanecem válidas até você
estar pronto para submeter.

## Como funciona

Em vez de um blockhash recente (válido ~150 blocos), você usa uma **conta
nonce**, uma conta especial que armazena um valor _único_. Cada transação usando
este nonce deve "avançá-lo" como primeira instrução, prevenindo ataques de
repetição.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  STANDARD BLOCKHASH                                                         │
│                                                                             │
│    ┌──────┐      ┌──────────┐                                               │
│    │ Sign │ ───▶ │  Submit  │     ⏱️ Must happen within ~90 seconds         │
│    └──────┘      └──────────┘                                               │
│       │                                                                     │
│       └─────────  Transaction expires if not submitted in time              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  DURABLE NONCE                                                              │
│                                                                             │
│    ┌──────┐      ┌───────┐       ┌─────────┐      ┌──────────┐              │
│    │ Sign │ ───▶ │ Store │ ───▶  │ Approve │ ───▶ │  Submit  │              │
│    └──────┘      └───────┘       └─────────┘      └──────────┘              │
│                                                                             │
│    Transaction remains valid until you submit it                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

<Callout type="info">
  A conta nonce custa ~0,0015 SOL para isenção de rent. Uma conta nonce = uma
  transação pendente por vez. Para fluxos de trabalho paralelos, crie múltiplas
  contas nonce.
</Callout>

## Configuração: criar uma conta nonce

Criar uma conta nonce requer duas instruções numa única transação:

1. **Criar a conta** usando `getCreateAccountInstruction` do System Program
2. **Inicializá-la como nonce** usando `getInitializeNonceAccountInstruction`

```ts
import { generateKeyPairSigner } from "@solana/kit";
import {
  getNonceSize,
  getCreateAccountInstruction,
  getInitializeNonceAccountInstruction,
  SYSTEM_PROGRAM_ADDRESS
} from "@solana-program/system";

// Generate a keypair for the nonce account address
const nonceKeypair = await generateKeyPairSigner();

// Get required account size for rent calculation
const space = BigInt(getNonceSize());

// 1. Create the account (owned by System Program)
getCreateAccountInstruction({
  payer,
  newAccount: nonceKeypair,
  lamports: rent,
  space,
  programAddress: SYSTEM_PROGRAM_ADDRESS
});

// 2. Initialize as nonce account
getInitializeNonceAccountInstruction({
  nonceAccount: nonceKeypair.address,
  nonceAuthority: authorityAddress // Controls nonce advancement
});

// Assemble and send transaction to the network
```

## Construir uma transação diferida

Em vez de um blockhash recente, use o valor nonce como o tempo de vida da
transação. Para fazer isso, devemos primeiro buscar o valor nonce da conta nonce
e depois usá-lo para definir o tempo de vida da transação.

### Buscar o valor nonce

Primeiro, busque o valor nonce da conta nonce:

```ts
import { fetchNonce } from "@solana-program/system";

const nonceAccount = await fetchNonce(rpc, nonceAddress);
const nonceValue = nonceAccount.data.blockhash; // Use this as your "blockhash"
```

### Definir o tempo de vida da transação com nonce

Em vez de usar um blockhash recente que expira, use
`setTransactionMessageLifetimeUsingDurableNonce`. Esta função faz duas coisas:

1. Define o valor nonce como o "blockhash" da transação
2. Adiciona automaticamente a instrução `advanceNonceAccount` no início
   (obrigatória como a primeira instrução em todas as transações com nonce
   durável)

```ts
import {
  setTransactionMessageLifetimeUsingDurableNonce,
  type Nonce
} from "@solana/kit";

setTransactionMessageLifetimeUsingDurableNonce(
  {
    nonce: nonceAccount.data.blockhash as Nonce,
    nonceAccountAddress: nonceAddress,
    nonceAuthorityAddress: authorityAddress
  },
  transactionMessage
);
```

## Assinar e armazenar

Após construir, assine a transação e serialize-a para armazenamento:

```ts
import {
  signTransactionMessageWithSigners,
  getBase64EncodedWireTransaction
} from "@solana/kit";

// Sign the transaction
const signedTx = await signTransactionMessageWithSigners(transactionMessage);

// Serialize for storage (database, file, etc.)
const serialized = getBase64EncodedWireTransaction(signedTx);
```

Armazene a string serializada na sua base de dados—ela permanece válida até que
o nonce seja avançado.

## Fluxo de trabalho de aprovação multipartidária

Desserialize a transação para adicionar assinaturas adicionais e depois
serialize novamente para armazenamento ou submissão:

```ts
import {
  getBase64Decoder,
  getTransactionDecoder,
  getBase64EncodedWireTransaction,
  partiallySignTransaction
} from "@solana/kit";

// Deserialize the stored transaction
const txBytes = getBase64Decoder().decode(serializedString);
const partiallySignedTx = getTransactionDecoder().decode(txBytes);

// Each approver adds their signature
const fullySignedTx = await partiallySignTransaction(
  [newSigner],
  partiallySignedTx
);

// Serialize again for storage or submission
const serialized = getBase64EncodedWireTransaction(fullySignedTx);
```

A transação pode ser serializada, armazenada e passada entre aprovadores. Assim
que todas as assinaturas necessárias forem recolhidas, submeta à rede.

## Executar quando estiver pronto

Quando as aprovações estiverem completas, envie a transação serializada para a
rede:

```ts
const signature = await rpc
  .sendTransaction(serializedTransaction, { encoding: "base64" })
  .send();
```

<Callout type="caution">
  Cada nonce só pode ser usado uma vez. Se uma transação falhar ou decidir não
  submetê-la, deve avançar o nonce antes de preparar outra transação com a mesma
  conta nonce.
</Callout>

## Avançar um nonce usado ou abandonado

Para invalidar uma transação pendente ou preparar o nonce para reutilização,
avance-o manualmente:

```ts
import { getAdvanceNonceAccountInstruction } from "@solana-program/system";

// Submit this instruction (with a regular blockhash) to invalidate any pending transaction
getAdvanceNonceAccountInstruction({
  nonceAccount: nonceAddress,
  nonceAuthority
});
```

Isto gera um novo valor nonce, tornando qualquer transação assinada com o valor
antigo permanentemente inválida.

## Considerações de produção

**Gestão de contas nonce:**

- Criar um conjunto de contas nonce para preparação paralela de transações
- Rastrear quais nonces estão "em uso" (têm transações assinadas pendentes)
- Implementar reciclagem de nonce após as transações serem submetidas ou
  abandonadas

**Segurança:**

- A autoridade nonce controla se as transações podem ser invalidadas. Considere
  separar a autoridade nonce dos signatários de transações para controlo
  adicional e separação de funções
- _Qualquer pessoa_ com os bytes de transação serializados pode submetê-la à
  rede

## Recursos relacionados

- [Introdução aos nonces duráveis](https://solana.com/developers/guides/advanced/introduction-to-durable-nonces)
