---
title: プログラムのデプロイ
description:
  Solana CLIを使用したSolanaプログラムの構築、デプロイ、管理の完全ガイド。
---

このセクションでは、Solana
CLIを使用してSolanaプログラムをデプロイする基本的なプロセスについて説明します。

## CLIコマンドリファレンス

| タスク                                      | コマンド                                                                                      |
| ------------------------------------------- | --------------------------------------------------------------------------------------------- |
| プログラムのビルド                          | `cargo build-sbf`                                                                             |
| 新規プログラムのデプロイ                    | `solana program deploy <path_to_program.so>`                                                  |
| 既存プログラムの更新                        | `solana program deploy <path_to_program.so>` (デプロイと同じ)                                 |
| プログラム情報の表示                        | `solana program show <program-id>`                                                            |
| プログラム権限の移譲                        | `solana program set-upgrade-authority <program-id> --new-upgrade-authority <path_to_keypair>` |
| プログラムを不変にする                      | `solana program set-upgrade-authority <program-id> --final`                                   |
| プログラムのクローズ                        | `solana program close <program-id> --bypass-warning`                                          |
| ウォレット残高の確認                        | `solana balance`                                                                              |
| エアドロップのリクエスト (devnet/localhost) | `solana airdrop 2`                                                                            |

## 主要な概念

詳細に入る前に、いくつかの用語を明確にしておきましょう：

- **プログラムID**：プログラムのオンチェーンアドレス。ユーザーはプログラムIDを参照することでプログラムと対話します。
- **program
  account**：プログラムのメタデータを格納するオンチェーンアカウント。program
  accountのアドレスがプログラムIDとなります。program accountはprogramdata
  accountのアドレスも保存します。
- **programdata
  account**：デプロイされたプログラムの実行可能コードを格納するオンチェーンアカウント。
- **プログラム権限**：プログラムを更新または閉じる権限を持つアカウント。デフォルトでは、これはCLIウォレットです。

## 前提条件

<Steps>

<Step>

### Solana CLIのインストール

まず、[Solana CLIをインストール](/docs/intro/installation)します。

</Step>

<Step>

### ウォレットの設定

インストール後、ローカルのkeypairウォレットを作成します。このウォレットのアドレスは、プログラムをデプロイする際のデフォルトのプログラム権限として設定されます：

```terminal
$ solana-keygen new
```

これによりデフォルトで `~/.config/solana/id.json` にkeypairが作成されます。

</Step>

<Step>

### クラスターの設定

デプロイ先のSolanaクラスターを選択します。`solana config get`コマンドを使用して現在の設定を確認してください：

```terminal
$ solana config get
Config File: ~/.config/solana/cli/config.yml
RPC URL: http://localhost:8899
WebSocket URL: ws://localhost:8900/ (computed)
Keypair Path: ~/.config/solana/id.json
Commitment: confirmed
```

必要に応じてクラスターを切り替えます：

```terminal
$ solana config set --url mainnet-beta
$ solana config set --url devnet
$ solana config set --url localhost
$ solana config set --url testnet
$ solana config set --url "https://your-rpc-url.com"
```

</Step>

<Step>

### ウォレットへの資金提供

プログラムのデプロイには SOL が必要です。必要な量はプログラムのサイズによって異なります。

devnetまたはlocalhostの場合、`solana airdrop`コマンドを使用してウォレットに資金を提供します：

```terminal
$ solana airdrop 2
Requesting airdrop of 2 SOL
Signature: 5zQKxvRdgJDA8fRGPdKfGxRLnLpwmNnMXGYxfBqFSUPqc5BTmFPrTG8vnC4HvKDVY8zQ8aQxZxcEE7WFpGhZGVAA
2 SOL
```

ウォレットの残高を確認します：

```terminal
$ solana balance
2 SOL
```

</Step>

</Steps>

## 基本操作

### プログラムのビルド

プログラムをビルドするには、`cargo build-sbf`コマンドを使用します：

```terminal
$ cargo build-sbf
```

<ScrollyCoding>

## !!steps サンプルプログラム

これは「Hello, Solana!」をプログラムログに出力する最小限のSolanaプログラムです。

<CodePlaceholder title="src/lib.rs" />

```rs !! title="src/lib.rs"
use solana_program::{
    account_info::AccountInfo, entrypoint, entrypoint::ProgramResult, msg, pubkey::Pubkey,
};

entrypoint!(process_instruction);

pub fn process_instruction(
    _program_id: &Pubkey,
    _accounts: &[AccountInfo],
    _instruction_data: &[u8],
) -> ProgramResult {
    msg!("Hello, Solana!");
    Ok(())
}
```

```toml !! title="Cargo.toml"
[package]
name = "hello_world"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "lib"]

[dependencies]
solana-program = "2.2.0"
```

## !!steps ビルド出力

`cargo build-sbf`コマンドを使用してプログラムをビルドします：

```terminal
$ cargo build-sbf
```

これにより`target/deploy/`に2つの重要なファイルが作成されます：

1. `hello_world-keypair.json`：公開鍵がプログラムIDとして使用されるkeypairファイル
2. `hello_world.so`：コンパイルされたプログラム実行ファイル

```json !! title="target/deploy/hello_world-keypair.json"
[
  203, 253, 43, 62, 165, 111, 94, 222, 105, 225, 218, 85, 143, 9, 114, 96, 243,
  181, 114, 89, 72, 230, 124, 85, 59, 165, 198, 23, 240, 212, 23, 154, 229, 241,
  153, 61, 153, 105, 79, 204, 193, 163, 33, 65, 82, 183, 49, 240, 224, 137, 248,
  24, 128, 25, 192, 197, 118, 235, 239, 67, 85, 156, 219, 231
]
```

```txt !! title="target/deploy/hello_world.so"
[binary executable file]
```

</ScrollyCoding>

### プログラムサイズとコストの確認

プログラムをデプロイするには、プログラムのサイズに基づいてプログラムアカウントにSOLを割り当てる必要があります。プログラムが大きいほど、デプロイに必要なSOLも多くなります。

プログラムのサイズを確認します：

```terminal
$ wc -c < ./target/deploy/hello_world.so
18504
```

このサイズ（バイト）に必要なSOLを計算します：

```terminal
$ solana rent 18504
Rent-exempt minimum: 0.12967872 SOL
```

<Callout type="info">
  デプロイトランザクション手数料をカバーするために、表示されている金額よりも少し多めのSOLが必要です。
</Callout>

### プログラムのデプロイ

`solana program deploy`コマンドを使用してプログラムをデプロイします：

```terminal
$ solana program deploy ./target/deploy/hello_world.so
Program Id: 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
Signature: 2BYwsqRP7ZwBNQvJp3S8bphTJ4zKW5JBPVMqCTE5KyLkP8xHzAyUEeC4LdTgjJdGBKHWNCkRF8Mf1T1WkLFyEu8W
```

表示される**プログラムID**は、ネットワーク上のプログラムの永続的なアドレスです。

<Callout>

（自動生成されたものではなく）特定のプログラムIDでデプロイするには、次のようにします：

```terminal
$ solana program deploy ./target/deploy/hello_world.so --program-id ./custom-keypair.json
```

`solana-keygen`コマンドを使用して新しいkeypairを生成できます：

```terminal
$ solana-keygen new -o ./custom-keypair.json
```

</Callout>

### プログラムの更新

同じ `solana program deploy` コマンドを使用してプログラムを更新します：

1. プログラムコードに変更を加える
2. プログラムを再ビルドする: `cargo build-sbf`
3. 更新をデプロイする:

```terminal
$ solana program deploy ./target/deploy/hello_world.so
Program Id: 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
Signature: 3zKnXDfEm1R8hVcEmTnNFYUaFjVVbLJrKdFj5hBMXoBRfz8xGyDhCYgKr9YY5KxKYPEUQQVfwEPNz9hQGvYhLNBJ
```

<Callout type="info">

更新したプログラムが現在割り当てられているよりも多くのスペース（バイト）を必要とする場合、デプロイメントは自動的にプログラムアカウントを拡張します。これは新しいプログラムが前のバージョンより大きい場合に発生します。プログラムアカウントは新しいプログラムを格納するために追加のバイトが必要です。CLIは必要なSOLを計算し、自動的にあなたのウォレットから差し引きます。

手動でプログラムを拡張してより多くのバイトを割り当てることもできます：

```terminal
$ solana program extend 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE 1000
Extended Program Id 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE by 1000 bytes
```

</Callout>

## プログラム管理

プログラムがデプロイされると、プログラムアカウントを管理するためのいくつかの一般的なコマンドがあります。

### プログラムメタデータの表示

プログラムメタデータを確認するには、`solana program show` コマンドを使用します：

```terminal
$ solana program show 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE
```

<WithNotes>

出力例：

```txt
$ solana program show 7283x8k8fyBcfaFLyPsxbd2VV1AMmZFP7FNoyTXVKJw7
# !tooltip[/Program Id/] program-id
Program Id: 7283x8k8fyBcfaFLyPsxbd2VV1AMmZFP7FNoyTXVKJw7
# !tooltip[/Owner/] owner
Owner: BPFLoaderUpgradeab1e11111111111111111111111
# !tooltip[/ProgramData Address/] program-data-address
ProgramData Address: Gqn7YQVCP8NtYV1qkEqR4Udhj8EJ3fkikvS7HskCNQ7c
# !tooltip[/Authority/] authority
Authority: 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1
# !tooltip[/Last Deployed In Slot/] last-deployed-in-slot
Last Deployed In Slot: 6573
# !tooltip[/Data Length/] data-length
Data Length: 18504 (0x4848) bytes
# !tooltip[/Balance/] balance
Balance: 0.12999192 SOL
```

### !program-id

プログラムIDは、プログラムアカウントのオンチェーンアドレスです。ユーザーや他のプログラムは、トランザクションでこのIDを参照することであなたのプログラムを呼び出します。

### !owner

オーナーは、このプログラムのデプロイに使用されたローダーを識別します。ほとんどのプログラムでは、これはBPFアップグレード可能ローダーになります。

### !program-data-address

プログラムデータアドレスは、プログラムの実行可能コードを格納する別のアカウントを指します。

### !authority

Authorityは、このプログラムをアップグレードまたはクローズする権限を持つアカウントです。Authorityのみがプログラムの更新をデプロイしたり、プログラムをクローズしてプログラムに割り当てられたSOLを回収したりできます。

### !last-deployed-in-slot

Last Deployed In Slotは、このプログラムが最後に更新されたタイミングを示します。

### !data-length

Data
Lengthは、このプログラムに割り当てられた合計バイト数を示します。このスペースは、現在のプログラムサイズよりも大きい将来の更新に対応できます。

### !balance

Balanceは、プログラムアカウントにデータを保存するために割り当てられたSOLを表示します。

</WithNotes>

### プログラム権限の移譲

プログラム権限を別のアカウントに移譲するには、`solana program set-upgrade-authority`コマンドを使用します：

```terminal
$ solana program set-upgrade-authority 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --new-upgrade-authority ./new-authority-keypair.json
```

<Callout type="warn">
  プログラム権限を移譲した後は、新しい権限のキーペアにアクセスできない限り、プログラムを更新することはできなくなります。
</Callout>

### プログラムを不変にする

プログラムを不変にするには、`solana program set-upgrade-authority`コマンドに`--final`フラグを付けてプログラム権限を削除します：

```terminal
$ solana program set-upgrade-authority 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --final
Account Type: Program
Authority: none
```

<Callout type="warn">
  プログラムが不変になると、二度と更新やクローズができなくなります。
</Callout>

### プログラムをクローズする

プログラムをクローズしてプログラムアカウントに割り当てられたSOLを回収するには、`solana program close`コマンドを使用します：

```terminal
$ solana program close 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE --bypass-warning
Closed Program Id 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE, 0.12999192 SOL reclaimed
```

<Callout type="warn">
  クローズすると、Program
  IDは再利用できなくなります。同じアドレスに新しいプログラムをデプロイすることはできません。
</Callout>

## ユーティリティコマンド

### すべてのプログラムを一覧表示

現在のウォレットが権限を持つすべてのプログラムを表示します：

```terminal
$ solana program show --programs
```

出力例:

```txt
Program Id                                       | Slot       | Authority                                      | Balance
-------------------------------------------------|------------|------------------------------------------------|-------------
7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE     | 249885434  | 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1   | 0.12999192
3KSGCk4m5hqJkTjPHBXUCPcqMwJnK3VmkqEsFUKKGJPK     | 249883212  | 5kh6HxYZiAebF8HWLsUWod2EaQQ6iWHpHYCz8UcmFbM1   | 0.28654328
```

### デプロイされたプログラムをダウンロードする

デプロイされたプログラムをダウンロードするには、`solana program dump`コマンドを使用します:

```terminal
$ solana program dump 7NxQjW8H8hVcqBKgXbVDWqGQCovHbqDW9p1SJJwUyTpE ./downloaded_program.so
Wrote program to ./downloaded_program.so
```

## 高度なオプション

### デプロイメントフラグ

Solanaネットワークが混雑している場合、これらのフラグを使用してプログラムのデプロイをサポートします。

使用例:

```terminal
$ solana program deploy ./target/deploy/hello_world.so \
    --with-compute-unit-price 10000 \
    --max-sign-attempts 10 \
    --use-rpc
```

オプションの説明:

- **`--with-compute-unit-price`**: コンピュートユニットあたりのマイクロラムポート（0.000001
  SOL）で優先手数料を設定します。現在のレートについては[Helius優先手数料API](https://docs.helius.dev/guides/priority-fee-api)を確認してください。優先手数料は、トランザクションを優先するために現在のリーダーに支払われる追加手数料です。
- **`--max-sign-attempts`**: トランザクションが期限切れになった場合に新しいブロックハッシュで再試行する回数。（デフォルト:
  5）
- **`--use-rpc`**: 設定されたRPCにトランザクションを送信します。このフラグには[Triton](https://triton.one/)や[Helius](https://www.helius.dev/)などのプロバイダーからの[ステーク加重](/developers/guides/advanced/stake-weighted-qos)
  RPC接続が必要です。
