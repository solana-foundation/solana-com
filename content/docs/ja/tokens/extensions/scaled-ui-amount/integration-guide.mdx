---
title: スケールドUI金額統合ガイド
description: アプリケーションでスケールドUI金額拡張機能を使用するトークンを統合する方法を学びましょう。
---

# SolanaでスケールドUI金額拡張機能をサポートする

## 背景

最近、「スケールドUI金額」と呼ばれる新しいトークン拡張機能が登場しました。これにより、トークン発行者はユーザーのトークン残高のUI金額を計算する際に使用する乗数を指定できるようになりました。これにより、発行者はリベーストークンを作成したり、株式分割などを可能にしたりできます。この拡張機能は、利子付きトークン拡張機能と同様に、純粋に見た目上のUI金額を提供します。基礎となる計算や送金はすべてプログラム内の生の金額を使用して行われます。

### リソース：

- [開発者ドキュメント](https://www.solana-program.com/docs/token-2022/extensions#scaled-ui-amount)
- [拡張機能Rustコード](https://github.com/solana-program/token-2022/tree/main/program/src/extension/scaled_ui_amount)
- [金額からUI金額へのRustコード](https://github.com/solana-program/token-2022/blob/main/program/src/processor.rs#L1425)

## 目標

- エンドユーザーに最高のUXを提供する
- チームがエコシステム全体で利子付きトークンの統一された体験を作成するための明確で分かりやすいガイドラインを提供する
- スケールドUI金額拡張機能との統合に必要なチームの作業を減らすための作業を特定し計画する

## 要約

- エンドユーザーは可能な限り、トークン価格、トークン残高、トークン金額にUIAmount（生の金額 × 乗数）を使用して操作すべきです
- dAppやサービスプロバイダーはすべての計算に生の金額と非スケール価格を使用し、エッジでユーザー向けに変換すべきです
- より簡単な統合のために、スケールされた金額と非スケールの金額の両方の履歴価格フィードを提供する必要があります
- 正確な履歴データのために、履歴乗数値にアクセスできるようにする必要があります

## 用語の定義

- マルチプライヤー：UI金額計算に使用される静的で更新可能な乗数
- UI金額：マルチプライヤー \* 生の金額（別名：スケールされた金額）
- 生の金額：金額（別名：スケールされていない金額）

## 現在の残高

### 表示用の現在の金額

- スケールされたUI金額拡張機能を使用するトークンの金額をエンドユーザーに表示する場合は、以下のいずれかを使用する必要があります：
  - UI金額/UI金額文字列（**_推奨_**）
  - 生の金額 \* マルチプライヤーの手動計算
  - トークンの小数点以下の桁数に基づいてこの値を切り捨てることをお勧めします。
    - 例：yUSDが6桁の小数点を持ち、ユーザーのUI金額が1.123456789の場合、「1.123456」と表示すべきです

### このデータの取得先：

- ユーザーのリアルタイム残高については、getTokenAccountBalanceまたはgetAccountInfoを呼び出すことで、上記の金額に関する最新情報を取得できます
- 任意の金額のUI金額を知る必要がある場合は、[`amountToUiAmountForMintWithoutSimulation`](https://github.com/solana-program/token-2022/blob/main/clients/js-legacy/src/actions/amountToUiAmount.ts#L164)（web3.js
  v1）関数を呼び出すか、amountToUiAmountを使用してトランザクションをシミュレートすることで計算できます。
  - 注意：amountToUiAmountはトランザクションシミュレーションを必要とするため、残高を持つ有効な手数料支払者も必要です。このため、これは残高を取得するデフォルトの方法であるべきではありません。

### 現在の金額の更新

発行者はいつでもマルチプライヤーを更新できるため、アカウント残高を最新の状態に保つために定期的にポーリングすることを検討できます。発行者がこのマルチプライヤーを更新するのは、1日に1回以上行うことはほとんどありません。将来の日付にマルチプライヤーが設定されている場合は、この更新時間に自動的にポーリングすることができます

## トランザクション内のトークン金額（転送/スワップなど）

- ユーザーはスケーリングされた「UIAmount」として解釈される金額を入力する必要があります。これを処理するアプリは、トランザクション用の生のトークン量に変換する必要があります。
  - 丸め問題がある場合は、切り捨てを行い、トランザクションが失敗するリスクよりも、わずかなダスト（端数）を残すことを優先してください
  - この変換を行うには、
    [`uiAmountToAmountForMintWithoutSimulation`](https://github.com/solana-program/token-2022/blob/main/clients/js-legacy/src/actions/amountToUiAmount.ts#L312C23-L312C63)
    （web3.js
    v1）関数を使用するか、amountToUiAmountを使用してトランザクションをシミュレートすることができます。
- ユーザーが「最大」または「すべて」の残高でアクションを実行するよう要求した場合、アプリは合計の生の金額を使用する必要があります。これにより、ダストが残らないようにします。
  - オプション：「最大」が使用される場合、ユーザーのストレージデポジットを返金するためにアカウントを自動的に閉じることを検討できます

## トークン価格

- トークン価格は可能な限り常にスケーリングされた価格として表示されるべきです。
- 価格フィードサービスプロバイダー（オラクルなど）の場合は、スケーリングされた価格と非スケーリングされた価格の両方を公開する必要があります。
  - 可能な限り、スケーリングされたUI金額拡張の複雑さを抽象化するSDK/APIを提供してください。

## 現在の乗数

- 現在の乗数は、いつでもトークンミントから `getAccountInfo`
  を呼び出すことで読み取ることができます。さらに、将来の乗数が設定されている場合、この情報もトークンミントから入手できます。UXを混乱させる可能性があるため、この乗数を表示しないことをお勧めします。

## 履歴データ

### 価格フィード用の履歴データ

- 履歴データを提供するサービスは、**スケーリングされたUI金額拡張のために、スケーリングされた価格と非スケーリングされた価格の両方を保存し、表示する**必要があります。
- 伝統的な金融界がストック分割を持つトークンに関連するチャートを扱う方法と一致するため、スケーリングされた金額が最も頻繁に使用されると予想しています。

### 金額の履歴データ

- 過去に送金された残高を表示したい場合は、特定のslotでの乗数にアクセスする必要があります。将来この計算を避けるために、トランザクションを処理する際に送金のUiAmountを保存することもできます。

## 後方互換性

- デフォルトでは、スケーリングされたUI金額拡張を理解していないウォレットやアプリケーションは、非スケーリング価格 \* 生の金額を乗算することで、アクティビティの正確な合計価格を表示します。
- ただし、非スケーリング価格が表示されるため、ユーザーに混乱を招く可能性があります。
- これにより、チームがスケーリングされたUI金額拡張を使用するトークンと互換性を持つようdappsを更新することを奨励し、このプロセス中のサポートを喜んで提供します。

## SPL-Tokenライブラリに追加するユーティリティ関数：

- **\[完了\]**
  AmountからUIAmountへ：現在の時点でミントと生の金額を指定してUIAmountを取得する関数
- **\[完了\]**
  UIAmountからAmountへ：現在の時点でミントとUIAmountを指定して生の金額を取得する関数
- **\[完了\]**
  特定のAmountからUIAmountへ：特定の乗数、小数点、生の金額を指定してUIAmountを取得する関数
- **\[完了\]**
  UIAmountからAmountへ：特定の乗数、小数点、UIAmountを指定して生の金額を取得する関数
- **\[TODO\]** @solana/kitのための上記すべてのヘルパー機能

## プラットフォームごとの受け入れ基準

### **一般要件**

| 要件                                           | 説明                                                                                                                                                                                                       | 優先度 |
| :--------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----- |
| UiAmountを使用したユーザーアクションのサポート | アプリ全体でUiAmountが有効になっている場合、すべてのユーザーアクションはUiAmountで入力する必要があります。アプリでUiAmountが表示されていない場合、アプリが更新されるまで生の金額を使用する必要があります。 | **P0** |

---

### **ウォレット**

| 要件                          | 説明                                                                                                                                | 優先度 |
| :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------- | :----- |
| スケーリングされた残高の表示  | スケーリングされた金額（uiAmount）を主要な残高として表示する。                                                                      | **P0** |
| トークン送金のサポート        | エンドユーザーはスケーリングされた残高（生の金額 \* 残高）で送金額を入力する必要がある。                                            | **P0** |
| スポット価格の表示            | ユーザー向けにスケーリングされた価格を表示する                                                                                      | **P0** |
| 取引履歴のメタデータ          | 可能な限り、各送金のスケーリングされた金額（UIAmount）を表示する。                                                                  | **P1** |
| 取引履歴での乗数更新の表示    | 乗数の更新が発生した場合、獲得した金額を含めてこれをユーザーの取引履歴にイベントとして表示する                                      | **P2** |
| 価格履歴グラフの表示          | 価格グラフにスケーリングされた価格を反映させる                                                                                      | **P1** |
| オンボーディング/ツールチップ | スケーリングされたui amount拡張機能を使用するトークンについて、ユーザーを教育するためのツールチップまたはオンボーディングを提供する | **P2** |

---

### **エクスプローラー**

| 要件                               | 説明                                                               | 優先度 |
| :--------------------------------- | :----------------------------------------------------------------- | :----- |
| トークン詳細ページの拡張           | スケーリングされた時価総額や現在の乗数などのメタデータを表示する   | **P0** |
| 残高のスケーリングされた残高の表示 | 現在の残高にスケーリングされた残高（UiAmount）を表示する。         | **P0** |
| 取引のスケーリングされた残高の表示 | 過去の取引の送金額にスケーリングされた残高（UiAmount）を表示する。 | **P0** |
| 取引のスケーリングされた価格の表示 | 過去の取引のスケーリングされた価格を表示する                       | **P1** |
| 乗数更新取引の適切な解析と表示     | 乗数更新に関する詳細を適切に表示する                               | **P2** |

---

### **市場データアグリゲーター（例：CoinGecko）**

| 要件                       | 説明                                                                                | 優先度 |
| :------------------------- | :---------------------------------------------------------------------------------- | :----- |
| スケールデータ用APIの更新  | 時間の経過に伴う乗数変更とスケールされた価格フィードを含むようにAPI機能を拡張する。 | **P0** |
| スケール調整を含む総供給量 | 総供給量と時価総額を表示する際、スケールされた残高を考慮する                        | **P0** |
| 過去の価格追跡             | 時間の経過に伴うスケールされた価格を使用した過去の価格チャートを提供する。          | **P1** |
| 過去の乗数追跡             | 利子付きトークンの乗数更新の履歴マーカーを提供する。                                | **P2** |
| 教育コンテンツまたは説明   | スケールされたトークンの仕組みを説明する簡単な説明やツールチップを含める。          | **P2** |

---

### **価格フィードプロバイダー**

| 要件                                 | 説明                                                                              | 優先度 |
| :----------------------------------- | :-------------------------------------------------------------------------------- | :----- |
| スケールおよび非スケール価格フィード | スケールされた価格と非スケールの両方の価格フィードを提供する。                    | **P0** |
| 過去の乗数データ                     | 過去の乗数変更を含むAPIを提供する。                                               | **P0** |
| 過去の価格データ                     | スケールされた金額と非スケールの金額の両方に基づく過去の価格を含むAPIを提供する。 | **P0** |

---

### **DEX（分散型取引所）**

| 要件                           | 説明                                                                                                       | 優先度 |
| :----------------------------- | :--------------------------------------------------------------------------------------------------------- | :----- |
| リベース済みトークン残高の表示 | UI上で取引または流動性提供のためのスケールされた残高を表示する（バックエンドは生の金額を使用可能）。       | **P0** |
| トークンアクションのサポート   | エンドユーザーはUiAmount残高（乗数 \* 生の金額）でアクション量を入力する必要がある。                       | **P0** |
| 価格フィードの適応             | 現在の価格を表示するために価格フィードが使用される場所では、エンドユーザーにスケールされた価格を提供する。 | **P1** |
| 価格履歴グラフの表示           | 価格グラフにスケールされた価格を反映する                                                                   | **P1** |
