---
title: 最佳实践
description:
  Solana 程序开发的最佳实践，包括：优化计算、模糊测试、代码库结构、索引等。
seoTitle: Solana 程序开发的最佳实践是什么？
keywords:
  - solana 最佳实践
  - 程序最佳实践
  - 程序开发
  - 程序安全
  - 开发最佳实践
  - 智能合约最佳实践
  - solana 智能合约
h1: Solana 程序最佳实践
---

> 这是 [Solana 工具包](/docs/toolkit/)
> 的测试版，目前仍在开发中。请将所有反馈作为 GitHub 问题发布
> [这里](https://github.com/solana-foundation/mucho/issues/new?title=%5Btoolkit%5D%20)。

## 优化计算使用

为了防止滥用计算资源，每笔交易都会分配一个 "计算预算"。该预算指定了有关
[计算单元](/docs/core/fees#compute-units) 的详细信息，包括：

- 交易可能执行的不同类型操作的计算成本（每次操作消耗的计算单元），
- 交易可以消耗的最大计算单元数（计算单元限制），
- 以及交易必须遵守的操作边界（如账户数据大小限制）

当交易耗尽其整个计算预算（计算预算耗尽）或超出某个边界（例如尝试超出
[最大调用堆栈深度](https://github.com/anza-xyz/agave/blob/b7bbe36918f23d98e2e73502e3c4cba78d395ba9/program-runtime/src/compute_budget.rs#L138)
或 [最大加载账户](/docs/core/fees#accounts-data-size-limit)
数据大小限制）时，运行时会停止交易处理并返回错误。这会导致交易失败且状态不会发生任何更改（除了交易费用会被
[收取](/docs/core/fees#fee-collection)）。

### 额外参考资料

- [如何优化计算](/developers/guides/advanced/how-to-optimize-compute)。
- [如何请求最佳计算](/developers/guides/advanced/how-to-request-optimal-compute)

## 保存 Bumps

> 程序派生地址 (PDAs) 是通过确定性派生的地址，看起来像标准的公钥，但没有关联的私钥。这些 PDAs 使用一个数值（称为 "bump"）派生，以确保 PDA 位于曲线之外，且无法拥有关联的私钥。它通过 "bump" 将地址从加密曲线上移开。

将 bump 保存到您的 Solana 智能合约账户状态中，可以确保地址生成的确定性、地址重建的效率、减少交易失败以及跨调用的一致性。

### 其他参考资料

- [如何推导 PDA](/docs/core/pda#how-to-derive-a-pda)
- [PDA Bumps 核心概念](/docs/core/pda#canonical-bump)
- [Bump Seed 规范化课程](/developers/courses/program-security/bump-seed-canonicalization)

## Payer-Authority 模式

Payer-Authority 模式是一种优雅的方式，用于处理账户的资金提供者（payer）与账户的所有者或管理者（authority）不同的情况。通过要求单独的签名者并在链上逻辑中验证它们，您可以在程序中维护清晰、稳健且灵活的所有权语义。

### Shank 示例

```rust
// Create a new account.
#[account(0, writable, signer, name="account", desc = "The address of the new account")]
#[account(1, writable, signer, name="payer", desc = "The account paying for the storage fees")]
#[account(2, optional, signer, name="authority", desc = "The authority signing for the account creation")]
#[account(3, name="system_program", desc = "The system program")]
CreateAccountV1(CreateAccountV1Args),
```

### Anchor 示例

```rust
#[derive(Accounts)]
pub struct CreateAccount<'info> {
    /// The address of the new account
    #[account(init, payer = payer_one, space = 8 + NewAccount::MAXIMUM_SIZE)]
    pub account: Account<'info, NewAccount>,

    /// The account paying for the storage fees
    #[account(mut)]
    pub payer: Signer<'info>,

    /// The authority signing for the account creation
    pub authority: Option<Signer<'info>>,

    // The system program
    pub system_program: Program<'info, System>
}
```

### 其他参考资料

- [Metaplex 关于 Payer-Authority 模式的指南](https://developers.metaplex.com/guides/general/payer-authority-pattern)
- [Helium Program Library 使用 Payer-Authority 模式](https://github.com/helium/helium-program-library/blob/master/programs/data-credits/src/instructions/change_delegated_sub_dao_v0.rs#L18)

## 不变量

实现不变量（invariants），即可以在指令结束时调用的函数，用于断言特定属性，因为它们有助于确保程序的正确性和可靠性。

```rust
require!(amount > 0, ErrorCode::InvalidAmount);
```

### 其他参考资料

- [完整项目代码示例](https://github.com/solana-developers/developer-bootcamp-2024/blob/main/project-9-token-lottery/programs/token-lottery/src/lib.rs#L291)

## 优化索引

通过将固定大小的字段放在链上结构的开头，而将可变大小的字段放在末尾，可以使索引更容易。
