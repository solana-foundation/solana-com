---
title: 部署程序
description:
  学习如何使用Anchor框架和Solana
  Playground构建、部署和测试您的第一个Solana程序。这个面向初学者的指南将带您创建一个简单的程序，将其部署到devnet，运行测试，并关闭程序。
h1: 部署您的第一个Solana程序
---

在本节中，您将使用Anchor框架构建、部署和测试一个简单的Solana程序（智能合约）。完成后，您将在Solana区块链上部署您的第一个程序。

本节的目的是让您熟悉Solana
Playground。该指南在程序派生地址（PDA）和跨程序调用（CPI）部分中详细介绍了更复杂的示例。有关更多详细信息，请参阅[Solana上的程序](/docs/core/programs)页面。

<Steps>
  <Step>
    ### 创建Anchor项目

    首先，在新的浏览器标签页中打开[https://beta.solpg.io](https://beta.solpg.io)。

    * 点击左侧面板上的"创建新项目"按钮。

    * 输入项目名称，选择Anchor作为框架，然后点击"创建"按钮。

    ![New Project](/assets/docs/intro/quickstart/pg-new-project.gif)

    您将看到一个新创建的项目，程序代码位于`src/lib.rs`文件中。

    这个基本的Solana程序创建一个新账户并在其中存储一个数字。该程序包含一个指令（`initialize`），它：

    * 需要一个*rs`data: u64`*&#x53C2;数作为输入
    * 创建一个新账户
    * 将*rs`data: u64`*&#x53C2;数的值保存在账户的数据中
    * 将消息记录到交易的程序日志中

    <WithNotes>
      ```rust title="lib.rs"
      use anchor_lang::prelude::*;

      // 这是你程序的公钥，当你构建项目时
      // 它会自动更新。
      // !tooltip[/declare_id/] declare_id
      declare_id!("11111111111111111111111111111111");

      // !tooltip[/program/] program
      #[program]
      mod hello_anchor {
          use super::*;
          // !tooltip[/data: u64/] parameter
          pub fn initialize(ctx: Context<Initialize>, data: u64) -> Result<()> {
              // !tooltip[/ctx.accounts.new_account.data = data/] initialize
              ctx.accounts.new_account.data = data;
              // !tooltip[/msg!/] msg
              msg!("Changed data to: {}!", data); // 消息将显示在交易日志中
              Ok(())
          }
      }

      // !tooltip[/Accounts/] accounts
      #[derive(Accounts)]
      pub struct Initialize<'info> {
          // 我们必须指定空间以初始化账户。
          // 前8个字节是默认账户鉴别器，
          // 接下来的8个字节来自NewAccount.data的u64类型。
          // (u64 = 64位无符号整数 = 8字节)
          // !tooltip[/account/] constraints
          #[account(
            // !tooltip[/init/] init
            init,
            // !tooltip[/payer/] payer
            payer = signer,
            // !tooltip[/space/] space
            space = 8 + 8
          )]
          pub new_account: Account<'info, NewAccount>,
          // !tooltip[/account/] constraints
          #[account(mut)]
          pub signer: Signer<'info>,
          pub system_program: Program<'info, System>,
      }

      // !tooltip[/account/] account
      #[account]
      pub struct NewAccount {
          data: u64
      }
      ```

      ### !declare\_id

      *rs`declare_id!()`* 宏指定了你程序在链上的地址。
      Solana Playground在你构建项目时会更新这个地址。

      ### !program

      *rs`#[program]`* 属性注解了一个包含代表程序指令的函数的模块。

      ### !accounts

      *rs`#[derive(Accounts)]`* 属性注解了一个包含程序账户的结构体。

      ### !account

      *rs`#[account]`* 属性定义了一个结构体，表示该程序可以创建和拥有的账户的数据类型。

      ### !constraints

      这些*rs`#[account(...)]`*&#x5C5E;性指定了账户的约束条件。

      这些约束添加了Anchor提供的常见检查或功能，以增强程序安全性。

      ### !parameter

      这是调用指令时传递给指令的值。

      ### !initialize

      *rs`ctx.accounts.new_account.data`*&#x662F;访问`data`字段，该字段属于
      `new_account`账户，并将其设置为`data: u64`参数的值。

      ### !msg

      *rs`msg!`*&#x5B8F;将消息记录到交易的程序日志中。

      ### !init

      `init` constraint 指定程序必须创建账户。在底层，这个约束调用系统程序创建一个新账户，并使当前程序成为其所有者。作为程序所有者，该程序随后可以写入账户数据。

      ### !payer

      `payer` constraint 指定支付新账户费用的账户。

      ### !space

      `space` constraint 指定为账户分配的字节数。
    </WithNotes>

    <Accordions>
      <Accordion title="解释">
        目前，这涵盖了程序代码的高级概述：

        <WithMentions>
          * declare\_id! 宏指定程序在链上的地址。Solana Playground 在下一步构建程序时会自动更新此地址。

          ```rs
          declare_id!("11111111111111111111111111111111");
          ```
        </WithMentions>

        <WithMentions>
          * [`#[program]`](mention:one) 属性注解包含表示程序指令的函数的模块。

          ```rs
          // !mention one
          #[program]
          mod hello_anchor {
              use super::*;
              // !mention two
              pub fn initialize(ctx: Context<Initialize>, data: u64) -> Result<()> {
                  // !mention three
                  ctx.accounts.new_account.data = data;
                  msg!("Changed data to: {}!", data); // Message will show up in the tx logs
                  Ok(())
              }
          }
          ```

          在这个例子中，[`initialize`](mention:two) 指令接受两个参数：

          1. `ctx: Context<Initialize>` - 将此指令所需的账户传递给函数，这些账户在 `Initialize` 结构中指定。
          2. `data: u64` - 调用指令时必须提供的自定义参数。

          函数体[将`data`字段设置为`new_account`](mention:three)中提供的`data`参数，然后向程序日志打印一条消息。
        </WithMentions>

        <WithMentions>
          * [`#[derive(Accounts)]`](mention:one)属性定义了一个结构体，用于指定特定指令所需的账户，其中每个字段代表一个单独的账户。

            Anchor通过字段类型（例如`Signer<'info>`）和约束条件（例如`#[account(mut)]`）自动处理与账户验证相关的常见安全检查。

            ```rs
            // !mention one
            #[derive(Accounts)]
            pub struct Initialize<'info> {
                #[account(init, payer = signer, space = 8 + 8)]
                pub new_account: Account<'info, NewAccount>,
                #[account(mut)]
                pub signer: Signer<'info>,
                pub system_program: Program<'info, System>,
            }
            ```
        </WithMentions>

        <WithMentions>
          * [`#[account]`](mention:one)属性定义了一个结构体，表示此程序创建和拥有的账户的数据类型。

          ```rs
          // !mention one
          #[account]
          pub struct NewAccount {
            data: u64
          }
          ```
        </WithMentions>
      </Accordion>
    </Accordions>
  </Step>

  <Step>
    ### 构建和部署程序

    要构建程序，只需运行`build` 在终端中。`build` 命令
    编译程序。程序字节码在部署时会存储在可执行
    程序账户中。

    ```terminal
    $ build
    构建中...
    构建成功。用时1.46秒完成。
    ```

    Solana Playground会更新 *rs`declare_id!()`* 中的地址。
    这个地址代表您程序在链上的地址（程序ID）。

    构建程序后，在终端中运行 *shell`deploy`* 将程序
    部署到网络（默认为devnet）。程序部署需要
    为存储程序的链上账户分配SOL。

    部署前，请确保您有足够的SOL。您可以通过在Playground终端中
    运行 *shell`solana airdrop 5`* 或使用
    [Web水龙头](https://faucet.solana.com/) 获取devnet SOL。

    ```terminal
    $ deploy
    部署中... 这可能需要一些时间，取决于程序大小和网络状况。
    警告：1个交易未确认，正在重试...
    部署成功。用时19秒完成。
    ```

    您也可以使用左侧面板上的 `构建` 和 `部署` 按钮。

    ![Build and Deploy](/assets/docs/intro/quickstart/pg-build-deploy.png)

    部署程序后，您可以调用其指令。
  </Step>

  <Step>
    ### 测试程序

    <WithMentions>
      启动代码包含一个位于`tests/anchor.test.ts`的测试文件。这个文件演示了如何从客户端调用程序的[`initialize`](mention:one)指令。

      ```ts title="anchor.test.ts"
      // 无需导入：web3、anchor、pg等都是全局可用的

      describe("Test", () => {
        it("initialize", async () => {
          // 为新账户生成密钥对
          const newAccountKp = new web3.Keypair();

          // 发送交易
          const data = new BN(42);
          const txHash = await pg.program.methods
            // !mention one
            .initialize(data)
            .accounts({
              newAccount: newAccountKp.publicKey,
              signer: pg.wallet.publicKey,
              systemProgram: web3.SystemProgram.programId
            })
            .signers([newAccountKp])
            .rpc();
          console.log(`使用 'solana confirm -v ${txHash}' 查看日志`);

          // 确认交易
          await pg.connection.confirmTransaction(txHash);

          // 获取创建的账户
          const newAccount = await pg.program.account.newAccount.fetch(
            newAccountKp.publicKey
          );

          console.log("链上数据为：", newAccount.data.toString());

          // 检查链上数据是否等于本地的'data'
          assert(data.eq(newAccount.data));
        });
      });
      ```
    </WithMentions>

    部署程序后，在终端中运行*shell`test`*&#x6765;执行测试文件。

    ```terminal
    $ test
    运行测试...
      hello_anchor.test.ts:
      hello_anchor
        使用 'solana confirm -v 3TewJtiUz1EgtT88pLJHvKFzqrzDNuHVi8CfD2mWmHEBAaMfC5NAaHdmr19qQYfTiBace6XUmADvR4Qrhe8gH5uc' 查看日志
        链上数据为：42
        ✔ initialize (961ms)
      1 passing (963ms)
    ```

    查找确认测试成功通过的输出。

    你也可以使用左侧面板上的`测试`按钮。

    ![Run Test](/assets/docs/intro/quickstart/pg-test.png)

    然后，你可以通过运行`solana confirm -v`命令并指定测试输出中的交易哈希（签名）来查看交易日志：

    ```terminal
    $ solana confirm -v [交易哈希]
    ```

    例如：

    ```terminal
    $ solana confirm -v 3TewJtiUz1EgtT88pLJHvKFzqrzDNuHVi8CfD2mWmHEBAaMfC5NAaHdmr19qQYfTiBace6XUmADvR4Qrhe8gH5uc
    RPC URL: https://api.devnet.solana.com
    默认签名者: Playground 钱包
    确认级别: confirmed

    交易在槽位 308150984 中执行：
      区块时间: 2024-06-25T12:52:05-05:00
      版本: legacy
      最近区块哈希: 7AnZvY37nMhCybTyVXJ1umcfHSZGbngnm4GZx6jNRTNH
      签名 0: 3TewJtiUz1EgtT88pLJHvKFzqrzDNuHVi8CfD2mWmHEBAaMfC5NAaHdmr19qQYfTiBace6XUmADvR4Qrhe8gH5uc
      签名 1: 3TrRbqeMYFCkjsxdPExxBkLAi9SB2pNUyg87ryBaTHzzYtGjbsAz9udfT9AkrjSo1ZjByJgJHBAdRVVTZv6B87PQ
      账户 0: srw- 3z9vL1zjN6qyAFHhHQdWYRTFAcy69pJydkZmSFBKHg1R (手续费支付者)
      账户 1: srw- c7yy8zdP8oeZ2ewbSb8WWY2yWjDpg3B43jk3478Nv7J
      账户 2: -r-- 11111111111111111111111111111111
      账户 3: -r-x 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r
      指令 0
        程序:   2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r (3)
        账户 0: c7yy8zdP8oeZ2ewbSb8WWY2yWjDpg3B43jk3478Nv7J (1)
        账户 1: 3z9vL1zjN6qyAFHhHQdWYRTFAcy69pJydkZmSFBKHg1R (0)
        账户 2: 11111111111111111111111111111111 (2)
        数据: [175, 175, 109, 31, 13, 152, 155, 237, 42, 0, 0, 0, 0, 0, 0, 0]
      状态: 成功
        手续费: ◎0.00001
        账户 0 余额: ◎5.47001376 -> ◎5.46900152
        账户 1 余额: ◎0 -> ◎0.00100224
        账户 2 余额: ◎0.000000001
        账户 3 余额: ◎0.00139896
      日志信息:
        程序 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r 调用 [1]
        程序日志: 指令: Initialize
        程序 11111111111111111111111111111111 调用 [2]
        程序 11111111111111111111111111111111 成功
        程序日志: 数据已更改为: 42!
        程序 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r 消耗了 5661/200000 计算单元
        程序 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r 成功

    已确认
    ```

    您还可以在[SolanaFM](https://solana.fm/)或
    [Solana Explorer](https://explorer.solana.com/?cluster=devnet)上通过搜索交易签名（哈希）查看交易详情。

    <Callout>
      请记得更新您使用的Explorer上的集群（网络）连接，使其与Solana Playground匹配。Solana Playground默认使用devnet集群。
    </Callout>
  </Step>

  <Step>
    ### 关闭程序

    最后，关闭程序可以完全恢复分配给链上程序的SOL。

    您可以通过运行以下命令并指定在*rs`declare_id!()`*&#x4E2D;找到的程序地址来关闭程序：

    ```terminal
    $ solana program close [ProgramID]
    ```

    例如：

    ```terminal
    $ solana program close 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r
    Closed Program Id 2VvQ11q8xrn5tkPNyeraRsPaATdiPx8weLAD8aD4dn2r, 2.79511512 SOL reclaimed
    ```

    <Accordions>
      <Accordion title="说明">
        只有程序的升级权限持有者才能关闭它。部署过程在您部署程序时设置升级权限。此账户拥有更新或关闭程序的专有权限。如果有人撤销了升级权限，程序将变得不可变，没有任何关闭或更新的可能性。

        在Solana Playground上部署程序时，您的Playground钱包会自动成为所有程序的升级权限持有者。
      </Accordion>
    </Accordions>

    恭喜您。您刚刚使用Anchor框架构建并部署了您的第一个Solana程序。
  </Step>
</Steps>
