---
title: "部署程序"
description: 使用Solana命令行界面将自定义程序上传到Solana区块链。
---

本指南假设您已了解以下主题：

* [Solana账户模型](/core/accounts)
* [Solana程序的基本概念](/core/programs)
* [开发自定义Solana程序](/programs/rust/)

## Loader-v3和Loader-v4

目前正在从loader-v3（program子命令）过渡到loader-v4（program **-v4**
子命令），因为loader-v3正在被弃用。

对于新部署，请使用 `solana program-v4 deploy` 而不是 `solana program deploy`。

要迁移现有程序（本质上是重新部署）：

```shell
solana program migrate ./target/deploy/your_program-keypair.json
```

## 准备工作

首先，需要构建程序（编译、链接、剥离）。

```shell
cargo +solana build --target sbpf-solana-solana --release
```

每次重新部署或首次部署前都必须执行此步骤。

检查默认支付账户是否有足够的资金，资金量应与可执行文件的大小成比例：

```shell
du -h ./target/deploy/your_program.so
solana balance
```

此外，每个程序都有一个程序账户和程序ID，程序ID是该程序账户的地址。以下命令为程序账户生成密钥对：

```shell
solana-keygen new -o ./target/deploy/your_program-keypair.json
```

每个程序只需执行一次此操作，之后同一程序的重新部署将重复使用此密钥对。

工具链包含一个快捷方式，但它正在被逐步淘汰/弃用：

```shell
cargo-build-sbf
```

## 初始部署

现在可以将可执行文件上传到程序账户：

### Loader-v3

该参数被称为`program-id`，尽管它实际上需要的是密钥对的文件路径：

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

### Loader-v4

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-keypair ./target/deploy/your_program-keypair.json
```

## 重新部署

再次将不同的可执行文件上传到同一个程序账户将会覆盖/替换它。然而，对于重新部署，只需要程序 ID（程序密钥对的公钥），而不需要整个密钥对，因为签名者是升级权限密钥对。

### Loader-v3

这与初始部署完全相同：

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

如果旧的可执行文件比新的短，可能需要先扩展 programdata 账户：

```shell
solana program extend ./target/deploy/your_program.so <ADDITIONAL_BYTES>
```

### Loader-v4

注意，初始部署使用了`program-keypair`，而重新部署使用的是`program-id`：

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

## 优先处理上传

在网络拥堵时，您可以使用一些额外的标志来帮助程序部署：

* `--with-compute-unit-price`：设置交易的计算单元价格，以每计算单元0.000001
  lamports（微lamports）为增量。使用[Helius提供的优先费用API](https://docs.helius.dev/guides/priority-fee-api)来获取优先费用的估计值。
* `--use-rpc`：将写入交易发送到配置的RPC而不是验证节点TPU。此标志需要[权益加权](/developers/guides/advanced/stake-weighted-qos)的RPC连接，如[Helius](https://www.helius.dev/)或[Triton](https://triton.one/)。也可以通过以下方式将此标志配置为默认值：`solana config set --url <RPC_URL>`。
* `--max-sign-attempts`：区块哈希过期后尝试签名或重新签名交易的最大次数。如果在程序部署期间发送的任何交易在最初选择的最近区块哈希过期后仍未确认，这些交易将使用新的最近区块哈希重新签名并重新发送。使用此设置调整交易签名迭代的最大次数。每个区块哈希的有效期约为60秒，这意味着使用默认值5将至少发送交易5分钟或直到所有交易都得到确认，以先到者为准。

## 恢复上传

上传可能会卡住或被中止。

### Loader-v3

如果程序部署失败，将会有一个挂起的中间缓冲区账户，其中包含非零余额。为了收回该余额，您可以通过向新的`deploy`调用提供相同的中间缓冲区来恢复失败的部署。

部署失败将打印一条错误消息，指定恢复生成的中间缓冲区密钥对所需的种子短语：

```
==================================================================================
使用 `solana-keygen recover` 和以下12个助记词恢复中间账户的临时密钥对文件：
==================================================================================
valley flat great hockey share token excess clever benefit traffic avocado athlete
==================================================================================
要继续部署，请将恢复的密钥对作为 [BUFFER_SIGNER] 传递给 `solana program deploy` 或
`solana program write-buffer`。或者要恢复账户的lamports，请将其作为
[BUFFER_ACCOUNT_ADDRESS] 参数传递给 `solana program drain`。
==================================================================================
```

要恢复密钥对：

```shell
solana-keygen recover -o ./target/deploy/buffer-keypair.json
```

当被询问时，输入12个助记词。

然后发出新的`deploy`命令并指定缓冲区：

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json --buffer ./target/deploy/buffer-keypair.json
```

### Loader-v4

可以从指定的字节偏移量恢复上传：

```shell
solana program deploy ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json --start-offset <BYTES_UPLOADED_SO_FAR>
```

## 最终确认

这是一个**不可逆**的操作。

通过移除其升级权限，程序可以变为不可变。

### Loader-v3

```shell
solana program set-upgrade-authority ./target/deploy/your_program-keypair.json --final
```

### Loader-v4

```shell
solana program finalize --program-id ./target/deploy/your_program-keypair.json
```

除了覆盖程序外，还可以通过构建已确认程序的链表，为用户提供选择他们想要使用的程序版本的选项：

```shell
solana program finalize --program-id ./target/deploy/your_program-keypair.json --next-version ../your_newer_program/target/deploy/your_newer_program-keypair.json
```

## 关闭

对于在loader-v3下部署的程序，只有其programdata账户、缓冲区账户以及锁定在这些账户中的资金可以被回收。程序账户连同程序ID和特别锁定在程序账户中的资金都将无法使用。

在loader-v4下部署的程序可以被关闭，其程序账户、程序ID和锁定的资金都可以再次用于其他用途。

### Loader-v3

这是一个**不可逆**的操作，适用于使用loader-v3部署的程序。

请注意，一旦程序被关闭，其程序ID将无法重复使用。尝试使用先前已关闭的程序ID部署程序将导致错误。如果您需要在关闭程序后重新部署，必须生成一个新的程序密钥对文件。

关闭单个programdata账户：

```shell
solana program close ./target/deploy/your_program-keypair.json
```

关闭与当前权限相关联的所有缓冲区账户：

```shell
solana program close --buffers
```

### Loader-v4

```shell
solana program-v4 close --program-id ./target/deploy/your_program-keypair.json
```

## 检查元数据

`show`子命令列出程序的元数据。

输出示例如下：

```shell
Program Id: 3KS2k14CmtnuVv2fvYcvdrNgC94Y11WETBpMUGgXyWZL
Owner: BPFLoaderUpgradeab1e11111111111111111111111
ProgramData Address: EHsACWBhgmw8iq5dmUZzTA1esRqcTognhKNHUkPi4q4g
Authority: FwoGJNUaJN2zfVEex9BB11Dqb3NJKy3e9oY3KTh9XzCU
Last Deployed In Slot: 63890568
Data Length: 5216 (0x1460) bytes
```

* `程序ID`是在调用程序时可以在指令的`program_id`字段中引用的地址。
* `所有者`：部署此程序的加载器。
* `ProgramData地址`是与程序账户关联的programdata账户，它保存程序的可执行文件（仅限loader-v3）。
* `状态`：`已撤回`，`已部署`或`已完成`（仅限loader-v4）。
* `权限`是程序的升级权限。
* `最后部署槽位`是程序最后部署的槽位。
* `数据长度`是为部署预留的空间大小。当前部署的程序实际使用的空间可能会更少。

### Loader-v3

查看特定程序：

```shell
solana program show ./target/deploy/your_program-keypair.json
```

查看使用默认权限部署的程序列表：

```shell
solana program show --programs
```

显示所有缓冲区账户，无论权限如何：

```shell
solana program show --buffers --all
```

指定不同的权限：

```shell
solana program show --programs --buffer-authority ~/.config/solana/authority-keypair.json
solana program show --buffers --buffer-authority ~/.config/solana/authority-keypair.json
```

### Loader-v4

查看特定程序：

```shell
solana program-v4 show --program-id ./target/deploy/your_program-keypair.json
```

查看使用默认权限部署的程序列表：

```shell
solana program-v4 show --all
```

查看使用特定权限部署的程序列表：

```shell
solana program-v4 show --authority ~/.config/solana/authority-keypair.json
```

## 下载可执行文件

有时下载并比较程序以确保它包含已知的可执行文件是很有用的。下载的文件可以被截断、哈希处理，并与原始程序文件的哈希值进行比较。

### Loader-v3

```shell
solana program dump ./target/deploy/your_program-keypair.json ./target/deploy/your_program.so
```

### Loader-v4

```shell
solana program download ./target/deploy/your_program.so --program-id ./target/deploy/your_program-keypair.json
```

## 高级：权限转移

更改给定程序的权利属于其权限持有者。这个权限可以转移到另一个密钥对，而不改变程序密钥对，这样程序ID保持不变。此外，单个权限可以控制多个程序账户。

如果在初始部署期间没有明确指定，则使用默认密钥对作为权限。这就是为什么在上述步骤中重新部署程序不需要明确指定权限的原因。

明确的权限对于离线签名和多实体管理的程序很有用。

首先，必须为权限生成一个密钥对：

```shell
solana-keygen new -o ~/.config/solana/authority-keypair.json
```

### Loader-v3

可以在部署期间指定权限：

```shell
solana program deploy ./target/deploy/your_program.so --upgrade-authority ~/.config/solana/authority-keypair.json
```

或者在部署后使用默认密钥对作为当前权限：

```shell
solana program set-upgrade-authority ./target/deploy/your_program-keypair.json --new-upgrade-authority ~/.config/solana/authority-keypair.json
```

或者在部署后指定当前权限：

```shell
solana program set-upgrade-authority ./target/deploy/your_program-keypair.json --upgrade-authority ~/.config/solana/authority-keypair.json --new-upgrade-authority ~/.config/solana/new_authority-keypair.json
```

### Loader-v4

可以在部署期间指定权限：

```shell
solana program-v4 deploy ./target/deploy/your_program.so --program-keypair ./target/deploy/your_program-keypair.json --authority ~/.config/solana/authority-keypair.json
```

或者在部署后使用默认密钥对作为当前权限：

```shell
solana program-v4 transfer-authority --program-id ./target/deploy/your_program-keypair.json --new-authority ~/.config/solana/authority-keypair.json
```

或者在部署后指定当前权限：

```shell
solana program-v4 transfer-authority --program-id ./target/deploy/your_program-keypair.json --authority ~/.config/solana/authority-keypair.json --new-authority ~/.config/solana/new_authority-keypair.json
```

## 高级：使用缓冲区进行两步重新部署

可执行文件不必直接上传到程序账户，而是可以先上传到临时缓冲区账户，然后在第二步（实际的重新部署/部署）中转移到程序账户。这对于离线签名和多实体管理的程序（如 DAO 投票选择或拒绝上传的可执行文件）在实际重新部署前非常有用。

请注意，使用缓冲区账户会使上传过程中所需的资金大约增加一倍，因为两个账户同时各持有一个可执行文件。

首先，必须为缓冲区账户创建一个密钥对：

```shell
solana-keygen new -o ~/.config/solana/buffer-keypair.json
```

缓冲区账户可以被重复用于不同的上传，并且不绑定到任何特定的程序账户。

### Loader-v3

```shell
solana program write-buffer ./target/deploy/your_program.so --buffer ~/.config/solana/buffer-keypair.json
solana program deploy --program-id ./target/deploy/your_program-keypair.json --buffer ~/.config/solana/buffer-keypair.json
```

### Loader-v4

```shell
solana program-v4 deploy ./target/deploy/your_program.so --buffer ~/.config/solana/buffer-keypair.json
solana program-v4 deploy --program-id ./target/deploy/your_program-keypair.json --buffer ~/.config/solana/buffer-keypair.json
```

## 高级：离线签名

某些安全模型要求将签名过程与交易广播分离，使签名密钥可以完全与任何网络断开连接，这也被称为离线签名。

请注意，只有重新部署可以在离线模式下执行。初始程序部署**必须**从在线机器执行，只有后续的程序重新部署才能利用离线签名。

典型的设置由两种不同的签名者组成：

* 在线签名者（费用支付者和缓冲账户的权限持有者）
* 离线签名者（程序账户的权限持有者）

一般流程是一个两步重新部署过程，还有一些额外步骤：

1. （在线）创建新程序
2. （在线）将权限转移给离线签名者
3. （在线）创建缓冲区并上传可执行文件
4. （可选）验证缓冲区的链上内容
5. （离线）签署使用缓冲区重新部署程序的交易 `--blockhash <值> --sign-only`
6. （在线）使用此签名广播重新部署交易
   `--blockhash <值> --signer <离线签名者公钥>:<离线签名者签名>`

查找最近的`blockhash`并粘贴它以生成离线交易签名。这个`blockhash`大约60秒后过期。如果你没有及时完成 - 只需获取另一个新的哈希值并重复操作直到成功，或者考虑使用持久交易随机数。
